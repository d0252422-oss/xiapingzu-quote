<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>拚拼組 系統櫃報價</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body{box-sizing:border-box;}
    html,body{height:100%;-webkit-overflow-scrolling:touch;}
    *{-webkit-tap-highlight-color:transparent;}
    .wood-bg{background-image:linear-gradient(135deg,#D6B28F 0%,#F5DEB3 45%,#C59F7B 100%);}
    .elevated{box-shadow:0 18px 40px rgba(15,23,42,0.25);}

    :root{ --scale: 1.25; }
    html{ font-size: calc(16px * var(--scale)); }

    .text-\[11px\]{ font-size: 0.90rem !important; }
    .text-xs{ font-size: 0.98rem !important; }
    .text-sm{ font-size: 1.05rem !important; }

    input, select, button{
      font-size: 1.08rem !important;
      line-height: 1.35 !important;
    }
    input, select{
      padding-top: 0.85rem !important;
      padding-bottom: 0.85rem !important;
    }
    button{
      padding-top: 0.95rem !important;
      padding-bottom: 0.95rem !important;
    }

    .text-slate-400, .text-slate-500{
      color: rgba(71,85,105,0.95) !important;
    }

    #totalDisplay, #footerTotal{
      font-size: 1.45rem !important;
    }
  </style>
</head>

<body class="min-h-screen bg-[#0f172a]">
<div class="max-w-md mx-auto min-h-screen flex flex-col bg-slate-100">

  <!-- HEADER -->
  <header class="relative overflow-hidden">
    <div class="wood-bg h-20 w-full"></div>
    <div class="absolute inset-x-0 bottom-0 h-20 bg-gradient-to-t from-[#022c22] via-[#064e3b]/95 to-transparent"></div>

    <div class="absolute top-3 right-4 z-20">
      <button id="fontToggleBtn"
        class="rounded-xl bg-white/90 backdrop-blur px-3 py-2 text-[11px] font-semibold text-slate-800 border border-white/70 shadow-sm active:scale-95">
        字體：1.25×
      </button>
    </div>

    <div class="absolute inset-0 flex flex-col justify-end px-4 pb-4">
      <p class="text-xs text-amber-100/90 tracking-[0.25em] mb-1">SYSTEM CABINET QUOTE</p>
      <h1 class="text-2xl font-semibold text-white">拚拼組 <span class="text-emerald-200 text-lg">系統櫃報價</span></h1>
      <p class="text-[11px] text-emerald-100/80 mt-1">輸入高/深/寬加入購物車｜由 Google Sheet 自動計價</p>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 overflow-y-auto px-4 pb-48 pt-4 space-y-4">

    <!-- 客戶資訊 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">1</span>
        客戶資訊（必填）
      </h2>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">客戶姓名</label>
          <input id="customerName" required type="text"
            class="w-full border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-emerald-300"
            placeholder="例如：王設計" />
        </div>

        <div>
          <label class="block text-xs text-slate-500 mb-1">聯絡電話</label>
          <input id="customerPhone" required type="tel"
            class="w-full border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-emerald-300"
            placeholder="必填" />
        </div>
      </div>
    </section>

    <!-- 新增櫃體 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">2</span>
        新增櫃體（輸入高/深/寬）
      </h2>

      <p id="loadStatus" class="text-[11px] text-slate-400">正在從 Google Sheet 載入價目表…</p>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">櫃體名稱（可選）</label>
          <input id="cabinetLabel" type="text"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：衣櫃 / 玄關櫃" />
        </div>

        <div>
          <label class="block text-xs text-slate-500 mb-1">櫃體類型</label>
          <select id="cabinetKind" class="w-full border rounded-lg px-3 py-2 text-sm">
            <option value="開門櫃">開門櫃</option>
            <option value="空櫃">空櫃</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">高度（cm）</label>
          <input id="heightCm" type="number" min="0" step="1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：210" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">深度（cm）</label>
          <input id="depthCm" type="number" min="0" step="1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：53" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">寬度（cm）</label>
          <input id="widthCm" type="number" min="0" step="1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：340" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">數量（組）</label>
          <input id="qtySet" type="number" min="1" step="1" value="1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：1" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">計價說明</label>
          <p class="text-[11px] text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-lg px-2 py-[6px]">
            寬度以表內寬度換算櫃數（不足一櫃補一櫃）
          </p>
        </div>
      </div>

      <!-- 配件選擇 -->
      <div class="border rounded-2xl p-3 bg-white">
        <div class="flex items-center justify-between">
          <p class="text-sm font-semibold text-slate-700">配件（可選）</p>
          <p class="text-[11px] text-slate-500">抽屜依深度限制｜板材多列｜五金多列｜抽屜/五金以輸入數量計價</p>
        </div>

        <div class="mt-3 space-y-3">

          <!-- 1) 抽屜（以輸入數量為主，不乘櫃數） -->
          <div class="border rounded-xl p-3 bg-slate-50">
            <p class="text-xs font-semibold text-slate-700 mb-2">1) 抽屜（依深度限制）</p>
            <div class="grid grid-cols-3 gap-2">
              <div class="col-span-2">
                <select id="drawerCode" class="w-full border rounded-lg px-3 py-2 text-sm" disabled>
                  <option value="">請先輸入深度</option>
                </select>
              </div>
              <div>
                <input id="drawerQty" type="number" min="1" step="1" value="1"
                  class="w-full border rounded-lg px-3 py-2 text-sm" disabled />
              </div>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">右側為「抽屜數量（組）」。本項不再乘櫃數。</p>
          </div>

          <!-- 2) 板材/封板：多列，獨立算才數（不乘櫃數） -->
          <div class="border rounded-xl p-3 bg-slate-50">
            <div class="flex items-center justify-between">
              <p class="text-xs font-semibold text-slate-700">2) 板材 / 封板（多列｜獨立計算）</p>
              <button id="addBoardLineBtn"
                class="rounded-lg bg-emerald-700 text-white text-[11px] font-semibold px-3 py-2 active:scale-95">
                + 新增一列
              </button>
            </div>

            <div class="mt-2 border rounded-lg p-2 bg-white">
              <p class="text-[11px] text-slate-600">計算：面積＝長×寬（cm²）｜才數＝面積÷900｜無條件進位｜總才＝（進位才/片）×片數</p>
            </div>

            <div id="boardLines" class="mt-2 space-y-2"></div>
            <p id="boardSumHint" class="text-[11px] text-slate-700 mt-2">—</p>
          </div>

          <!-- 3) 五金：多列（以輸入數量為主，不乘櫃數） -->
          <div class="border rounded-xl p-3 bg-slate-50">
            <div class="flex items-center justify-between">
              <p class="text-xs font-semibold text-slate-700">3) 五金（多列）</p>
              <button id="addHardwareLineBtn"
                class="rounded-lg bg-emerald-700 text-white text-[11px] font-semibold px-3 py-2 active:scale-95">
                + 新增一列
              </button>
            </div>

            <div id="hardwareLines" class="mt-2 space-y-2"></div>
            <p id="hardwareSumHint" class="text-[11px] text-slate-700 mt-2">—</p>

            <p class="text-[11px] text-slate-500 mt-2">每列金額＝單價×數量。本區不再乘櫃數。</p>
          </div>

          <p id="accWarn" class="hidden text-[11px] text-red-600"></p>
        </div>
      </div>

      <div class="border rounded-xl px-3 py-2 bg-slate-50">
        <p class="text-xs text-slate-600 font-medium">即時計算</p>
        <p id="matchHint" class="text-[11px] text-slate-500 mt-1">請輸入高/深/寬（cm），系統會自動匹配價目表並計價。</p>
        <div id="linePreview" class="text-sm font-semibold text-slate-800 mt-1">—</div>
      </div>

      <button id="addItemBtn"
        class="w-full mt-2 bg-emerald-700 text-white text-sm font-semibold py-2 rounded-xl shadow-md active:scale-95">
        加入購物車
      </button>
    </section>

    <!-- 購物車 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3 mb-2">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">3</span>
        購物車（櫃體）
      </h2>

      <div id="quoteList" class="space-y-2 text-sm">
        <p class="text-xs text-slate-400">尚未加入任何項目。</p>
      </div>

      <div class="border-t pt-2 mt-2 text-sm">
        <div class="flex justify-between items-center">
          <span class="text-slate-600 font-medium">小計</span>
          <span id="subtotalDisplay" class="font-semibold text-slate-800">—</span>
        </div>

        <div class="flex items-center justify-between mt-2 text-xs">
          <span class="text-slate-600">未滿五萬運費工資補貼</span>
          <span id="ufAmountDisplay" class="text-slate-700">+ $0</span>
        </div>

        <div class="flex justify-between items-center mt-2 border-t pt-2">
          <span class="text-slate-700 font-semibold">總價</span>
          <span id="totalDisplay" class="text-lg font-bold text-emerald-700">—</span>
        </div>
      </div>
    </section>

  </main>

  <!-- 底部 -->
  <footer class="fixed bottom-0 left-0 right-0 bg-[#022c22] border-t border-emerald-900/40">
    <div class="max-w-md mx-auto flex items-center justify-between px-4 py-3 gap-3">
      <div class="text-xs text-emerald-100">
        <p class="font-semibold">報價總額</p>
        <p id="footerTotal" class="text-lg font-bold text-emerald-300">—</p>
      </div>

      <button id="sendBtn"
        class="flex-1 bg-emerald-500 text-emerald-950 text-sm font-semibold py-2 rounded-xl shadow-lg active:scale-95">
        傳送報價
      </button>
    </div>
  </footer>

</div>

<script>
/* =======================
   Google Sheet CSV（固定 gid）
   ======================= */
const CABINETS_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=0&single=true&output=csv";

const DRAWERS_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=1520827127&single=true&output=csv";

const BOARDS_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=71905260&single=true&output=csv";

const HARDWARES_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=206474142&single=true&output=csv";

/* 櫃體表：高度/深度/寬度 mm，使用者輸入 cm -> ×10 */
const CM_TO_MM = 10;

/* 1 才 = 900 cm² */
const CAI_CM2 = 900;

/* 抽屜深度規則 */
const DRAWER_CODES_SHALLOW = ["深61","深62","深63"]; // 深度 <= 60cm
const DRAWER_CODES_DEEP    = ["深91","深92","深93"]; // 深度 > 60cm

let cabinetRows = [];
let drawersRows = [];
let boardsRows = [];
let hardwaresRows = [];
let cartItems = [];
let userId = null;

/* 板材多列暫存 */
let boardLines = []; // {id, code, lenCm, widCm, pieces}
let boardLineSeq = 1;
let boardOptionsHtml = "";

/* 五金多列暫存 */
let hardwareLines = []; // {id, code, qty}
let hardwareLineSeq = 1;
let hardwareOptionsHtml = "";

/* ===== 字體切換（1.25x / 2x）===== */
const SCALE_SMALL = 1.25;
const SCALE_LARGE = 2.0;
const SCALE_KEY = "pinpin_font_scale";

function applyScale(scale){
  const s = (scale === SCALE_LARGE ? SCALE_LARGE : SCALE_SMALL);
  document.documentElement.style.setProperty("--scale", String(s));
  try{ localStorage.setItem(SCALE_KEY, String(s)); }catch(e){}
  const btn = document.getElementById("fontToggleBtn");
  if(btn) btn.textContent = `字體：${s === 2 ? "2×" : "1.25×"}`;
}
function initScale(){
  let saved = null;
  try{ saved = parseFloat(localStorage.getItem(SCALE_KEY)); }catch(e){}
  if(saved === SCALE_LARGE) applyScale(SCALE_LARGE);
  else applyScale(SCALE_SMALL);
}
function toggleScale(){
  const cur = getComputedStyle(document.documentElement).getPropertyValue("--scale").trim();
  const curNum = parseFloat(cur);
  if(curNum >= 1.8) applyScale(SCALE_SMALL);
  else applyScale(SCALE_LARGE);
}

/* utils */
function parseCSV(text){
  const quotes=/^"|"$/g;
  return text.trim().split("\n").filter(Boolean).map(r =>
    r.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(v=>v.replace(quotes,"").trim())
  );
}
function escapeHtml(str){
  return String(str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function money(n){ return `$${(n||0).toLocaleString()}`; }
function normUnit(u){ return String(u||"").trim(); }
function roundCeilInt(x){ return Math.ceil(x - 1e-12); }

async function fetchCsv(url){
  const res = await fetch(url + "&rand=" + Math.random());
  if(!res.ok) throw new Error("CSV 讀取失敗：" + url);
  const text = await res.text();
  if(!text.includes("編碼")) throw new Error("CSV 內容不含表頭（編碼），可能未發佈或 gid 錯誤：" + url);
  return text;
}

function findByCode(rows, code){
  return rows.find(x => (x.code || "").trim() === (code || "").trim()) || null;
}

/* load cabinets */
async function loadCabinets(){
  const text = await fetchCsv(CABINETS_CSV);
  const rows = parseCSV(text);
  const header = rows[0];

  const idxCode  = header.indexOf("編碼");
  const idxName  = header.indexOf("名稱");
  const idxH     = header.indexOf("高度");
  const idxD     = header.indexOf("深度");
  const idxW     = header.indexOf("寬度");
  const idxPrice = header.indexOf("單價");
  const idxType  = header.indexOf("類型");

  cabinetRows = rows.slice(1).map(r => {
    const code = (r[idxCode] || "").trim();
    const name = (r[idxName] || "").trim();
    const heightMm = parseInt((r[idxH] || "0").replace(/[^0-9]/g,""), 10) || 0;
    const depthMm  = parseInt((r[idxD] || "0").replace(/[^0-9]/g,""), 10) || 0;
    const widthMm  = parseInt((r[idxW] || "0").replace(/[^0-9]/g,""), 10) || 0;
    const price = parseInt((r[idxPrice] || "0").toString().replace(/[^0-9]/g,""), 10) || 0;
    const type  = (r[idxType] || "").trim();
    return { code, name, heightMm, depthMm, widthMm, price, type };
  }).filter(x =>
    x.code && x.type === "櫃體" && x.price > 0 && x.heightMm > 0 && x.depthMm > 0 && x.widthMm > 0
  );
}

/* load simple tab */
async function loadSimpleTabFromUrl(url){
  const text = await fetchCsv(url);
  const rows = parseCSV(text);
  const header = rows[0];

  const idxCode  = header.indexOf("編碼");
  const idxName  = header.indexOf("名稱");
  const idxUnit  = header.indexOf("單位");
  const idxPrice = header.indexOf("單價");
  const idxType  = header.indexOf("類型");

  return rows.slice(1).map(r => {
    const code = (r[idxCode] || "").trim();
    const name = (r[idxName] || "").trim();
    const unit = (r[idxUnit] || "").trim();
    const price = parseInt((r[idxPrice] || "0").toString().replace(/[^0-9]/g,""), 10) || 0;
    const type = (r[idxType] || "").trim();
    return { code, name, unit, price, type };
  }).filter(x => x.code && x.price >= 0);
}

/* cabinet count */
function calcCabinetCount(totalWidthMm, baseWidthMm){
  const total = parseInt(totalWidthMm || "0", 10);
  const base  = parseInt(baseWidthMm  || "0", 10);
  if(!(total > 0 && base > 0)) return 0;
  const q = Math.floor(total / base);
  const r = total % base;
  return q + (r > 0 ? 1 : 0);
}

/* match rule */
function findBestRate(kind, inputHeightMm, inputDepthMm){
  const poolKind = cabinetRows.filter(x => (x.name || "").includes(kind));
  const candidates = poolKind.length ? poolKind : cabinetRows;

  let heightPool = candidates.filter(x => x.heightMm === inputHeightMm);
  if(!heightPool.length){
    const sorted = candidates.slice().sort((a,b)=>Math.abs(a.heightMm-inputHeightMm)-Math.abs(b.heightMm-inputHeightMm));
    const pickH = sorted[0]?.heightMm;
    heightPool = pickH ? candidates.filter(x => x.heightMm === pickH) : [];
  }
  if(!heightPool.length) return null;

  const depthSorted = heightPool.slice().sort((a,b)=>a.depthMm-b.depthMm);
  let best = depthSorted.find(x => x.depthMm >= inputDepthMm);
  if(!best) best = depthSorted[depthSorted.length-1] || null;
  return best;
}

/* ===== 板材/封板：算才數（長×寬 / 900，無條件進位） ===== */
function calcCaiByLenWid(lenCm, widCm){
  const L = parseFloat(lenCm || "0");
  const W = parseFloat(widCm || "0");
  if(!(L > 0 && W > 0)) return { area:0, raw:0, ceil:0 };
  const area = L * W;              // cm²
  const raw = area / CAI_CM2;      // 才（未進位）
  const ceil = roundCeilInt(raw);  // 無條件進位
  return { area, raw, ceil };
}

/* ===== UI elements ===== */
const cabinetKindEl = document.getElementById("cabinetKind");
const heightEl = document.getElementById("heightCm");
const depthEl  = document.getElementById("depthCm");
const widthEl  = document.getElementById("widthCm");
const qtySetEl = document.getElementById("qtySet");

const drawerCodeEl = document.getElementById("drawerCode");
const drawerQtyEl = document.getElementById("drawerQty");

const boardLinesEl = document.getElementById("boardLines");
const boardSumHintEl = document.getElementById("boardSumHint");

const hardwareLinesEl = document.getElementById("hardwareLines");
const hardwareSumHintEl = document.getElementById("hardwareSumHint");

const loadStatus = document.getElementById("loadStatus");
const matchHint = document.getElementById("matchHint");
const linePreview = document.getElementById("linePreview");
const accWarn = document.getElementById("accWarn");

const quoteList = document.getElementById("quoteList");
const subtotalDisplay = document.getElementById("subtotalDisplay");
const ufAmountDisplay = document.getElementById("ufAmountDisplay");
const totalDisplay = document.getElementById("totalDisplay");
const footerTotal = document.getElementById("footerTotal");

let currentMatch = null;
let currentComputed = null;

function setWarn(msg){
  if(msg){
    accWarn.classList.remove("hidden");
    accWarn.textContent = msg;
  }else{
    accWarn.classList.add("hidden");
    accWarn.textContent = "";
  }
}

/* ===== options builders ===== */
function buildBoardOptions(){
  boardOptionsHtml =
    `<option value="">不需要</option>` +
    boardsRows.filter(x=>x.price>0).map(x =>
      `<option value="${escapeHtml(x.code)}">${escapeHtml(x.code)}｜${escapeHtml(x.name)}｜${money(x.price)} / ${escapeHtml(x.unit||"")}</option>`
    ).join("");
}
function buildHardwareOptions(){
  hardwareOptionsHtml =
    `<option value="">不需要</option>` +
    hardwaresRows.filter(x=>x.price>0).map(x =>
      `<option value="${escapeHtml(x.code)}">${escapeHtml(x.code)}｜${escapeHtml(x.name)}｜${money(x.price)} / ${escapeHtml(x.unit||"")}（${escapeHtml(x.type||"")}）</option>`
    ).join("");
}

/* ===== 板材多列：新增/刪除/渲染 ===== */
function addBoardLine(preset){
  const id = "b" + (boardLineSeq++);
  boardLines.push({
    id,
    code: preset?.code || "",
    lenCm: preset?.lenCm ?? "",
    widCm: preset?.widCm ?? "",
    pieces: preset?.pieces ?? 1
  });
  renderBoardLines();
  updateMatchAndPreview();
}
function removeBoardLine(id){
  boardLines = boardLines.filter(x=>x.id !== id);
  renderBoardLines();
  updateMatchAndPreview();
}
function renderBoardLines(){
  if(!boardLines.length){
    boardLinesEl.innerHTML = `
      <div class="border rounded-lg p-3 bg-white">
        <p class="text-[11px] text-slate-500">尚未新增板材/封板。可按右上「新增一列」。</p>
      </div>
    `;
    boardSumHintEl.textContent = "—";
    return;
  }

  boardLinesEl.innerHTML = boardLines.map(line=>`
    <div class="border rounded-xl p-3 bg-white" data-id="${escapeHtml(line.id)}">
      <div class="flex items-start justify-between gap-2">
        <div class="flex-1 space-y-2">
          <select class="boardCode w-full border rounded-lg px-3 py-2 text-sm" data-id="${escapeHtml(line.id)}">
            ${boardOptionsHtml}
          </select>

          <div class="grid grid-cols-3 gap-2">
            <div>
              <label class="block text-[11px] text-slate-600 mb-1">長（cm）</label>
              <input class="boardLen w-full border rounded-lg px-3 py-2 text-sm" data-id="${escapeHtml(line.id)}"
                type="number" min="0" step="0.1" placeholder="例如：40" value="${escapeHtml(line.lenCm)}">
            </div>
            <div>
              <label class="block text-[11px] text-slate-600 mb-1">寬（cm）</label>
              <input class="boardWid w-full border rounded-lg px-3 py-2 text-sm" data-id="${escapeHtml(line.id)}"
                type="number" min="0" step="0.1" placeholder="例如：40" value="${escapeHtml(line.widCm)}">
            </div>
            <div>
              <label class="block text-[11px] text-slate-600 mb-1">片數</label>
              <input class="boardPieces w-full border rounded-lg px-3 py-2 text-sm" data-id="${escapeHtml(line.id)}"
                type="number" min="1" step="1" value="${escapeHtml(line.pieces)}">
            </div>
          </div>

          <div class="border rounded-lg p-2 bg-slate-50">
            <p class="text-[11px] text-slate-700 boardLineHint" data-id="${escapeHtml(line.id)}">—</p>
          </div>
        </div>

        <button class="removeBoardLine text-red-500 text-[11px] font-semibold px-2 py-1" data-id="${escapeHtml(line.id)}">刪除</button>
      </div>
    </div>
  `).join("");

  boardLines.forEach(line=>{
    const sel = boardLinesEl.querySelector(`select.boardCode[data-id="${CSS.escape(line.id)}"]`);
    if(sel) sel.value = line.code || "";
  });

  refreshBoardLinesHints();
}

function calcBoardLine(line){
  const code = (line.code || "").trim();
  if(!code) return { ok:true, empty:true, totalCai:0, amount:0, msg:"未選擇品項" };

  const row = findByCode(boardsRows, code);
  const unitPrice = row?.price || 0;
  const unit = row?.unit || "";
  const name = row?.name || code;

  const pieces = Math.max(1, parseInt(line.pieces || "1", 10));
  const { area, raw, ceil } = calcCaiByLenWid(line.lenCm, line.widCm);

  if(!(area > 0)){
    return {
      ok:false, empty:false,
      code, name, unitPrice, unit,
      totalCai:0, amount:0,
      msg:"已選擇品項，但長或寬未輸入（此列暫以 0 才計）",
      spec:{ pieces, areaCm2:0, rawCai:0, ceilCaiPerPiece:0 }
    };
  }

  const totalCai = ceil * pieces;
  const amount = unitPrice * totalCai;

  let unitWarn = "";
  if(normUnit(unit) && normUnit(unit) !== "才"){
    unitWarn = `｜注意：表內單位為「${unit}」，目前仍以「才數」計價請確認`;
  }

  const msg =
    `面積=${area.toFixed(2)}cm²，÷900=${raw.toFixed(4)}才 → 進位 ${ceil}才/片 × ${pieces}片 = ${totalCai}才｜${money(unitPrice)}×${totalCai}=${money(amount)}${unitWarn}`;

  return {
    ok:true, empty:false,
    code, name, unitPrice, unit,
    totalCai, amount,
    msg,
    spec:{ pieces, areaCm2:area, rawCai:raw, ceilCaiPerPiece:ceil }
  };
}

function refreshBoardLinesHints(){
  let sumCai = 0;
  let sumAmount = 0;
  const warns = [];

  boardLines.forEach(line=>{
    const res = calcBoardLine(line);
    const hintEl = boardLinesEl.querySelector(`.boardLineHint[data-id="${CSS.escape(line.id)}"]`);
    if(hintEl) hintEl.textContent = res.msg || "—";

    if(!res.empty){
      sumCai += (res.totalCai || 0);
      sumAmount += (res.amount || 0);

      if(!res.ok && res.msg) warns.push(res.msg);
      if(res.unit && normUnit(res.unit) !== "才"){
        warns.push(`板材 ${res.code} 單位為「${res.unit}」，非才；請確認 boards 分頁單位`);
      }
      if(!findByCode(boardsRows, (line.code||"").trim()) && (line.code||"").trim()){
        warns.push(`板材/封板編碼 ${line.code} 在 boards 分頁找不到（此列以 $0 計）`);
      }
    }
  });

  boardSumHintEl.textContent =
    boardLines.length
      ? `板材合計：${sumCai} 才｜小計 ${money(sumAmount)}`
      : "—";

  return { sumCai, sumAmount, warns };
}

/* ===== 五金多列：新增/刪除/渲染 ===== */
function addHardwareLine(preset){
  const id = "h" + (hardwareLineSeq++);
  hardwareLines.push({
    id,
    code: preset?.code || "",
    qty: preset?.qty ?? 1
  });
  renderHardwareLines();
  updateMatchAndPreview();
}
function removeHardwareLine(id){
  hardwareLines = hardwareLines.filter(x=>x.id !== id);
  renderHardwareLines();
  updateMatchAndPreview();
}
function renderHardwareLines(){
  if(!hardwareLines.length){
    hardwareLinesEl.innerHTML = `
      <div class="border rounded-lg p-3 bg-white">
        <p class="text-[11px] text-slate-500">尚未新增五金。可按右上「新增一列」。</p>
      </div>
    `;
    hardwareSumHintEl.textContent = "—";
    return;
  }

  hardwareLinesEl.innerHTML = hardwareLines.map(line=>`
    <div class="border rounded-xl p-3 bg-white" data-id="${escapeHtml(line.id)}">
      <div class="flex items-start justify-between gap-2">
        <div class="flex-1 space-y-2">
          <div class="grid grid-cols-3 gap-2">
            <div class="col-span-2">
              <select class="hardwareCode w-full border rounded-lg px-3 py-2 text-sm" data-id="${escapeHtml(line.id)}">
                ${hardwareOptionsHtml}
              </select>
            </div>
            <div>
              <input class="hardwareQty w-full border rounded-lg px-3 py-2 text-sm" data-id="${escapeHtml(line.id)}"
                type="number" min="1" step="1" value="${escapeHtml(line.qty)}">
            </div>
          </div>

          <div class="border rounded-lg p-2 bg-slate-50">
            <p class="text-[11px] text-slate-700 hardwareLineHint" data-id="${escapeHtml(line.id)}">—</p>
          </div>
        </div>

        <button class="removeHardwareLine text-red-500 text-[11px] font-semibold px-2 py-1" data-id="${escapeHtml(line.id)}">刪除</button>
      </div>
    </div>
  `).join("");

  // 套用目前 select 值
  hardwareLines.forEach(line=>{
    const sel = hardwareLinesEl.querySelector(`select.hardwareCode[data-id="${CSS.escape(line.id)}"]`);
    if(sel) sel.value = line.code || "";
  });

  refreshHardwareLinesHints();
}

function calcHardwareLine(line){
  const code = (line.code || "").trim();
  if(!code) return { ok:true, empty:true, qty:0, amount:0, msg:"未選擇品項" };

  const row = findByCode(hardwaresRows, code);
  const unitPrice = row?.price || 0;
  const unit = row?.unit || "";
  const name = row?.name || code;

  const qty = Math.max(1, parseInt(line.qty || "1", 10));
  const amount = unitPrice * qty;

  if(!row){
    return {
      ok:false, empty:false,
      code, name, unitPrice, unit,
      qty, amount:0,
      msg:`五金編碼 ${code} 在 hardwares 分頁找不到（此列以 $0 計）`
    };
  }

  const msg = `${money(unitPrice)} × ${qty}${unit ? unit : ""} = ${money(amount)}（${row.type || "五金"}）`;
  return { ok:true, empty:false, code, name, unitPrice, unit, qty, amount, msg };
}

function refreshHardwareLinesHints(){
  let sumAmount = 0;
  const warns = [];

  hardwareLines.forEach(line=>{
    const res = calcHardwareLine(line);
    const hintEl = hardwareLinesEl.querySelector(`.hardwareLineHint[data-id="${CSS.escape(line.id)}"]`);
    if(hintEl) hintEl.textContent = res.msg || "—";

    if(!res.empty){
      sumAmount += (res.amount || 0);
      if(!res.ok && res.msg) warns.push(res.msg);
    }
  });

  hardwareSumHintEl.textContent =
    hardwareLines.length
      ? `五金合計小計：${money(sumAmount)}`
      : "—";

  return { sumAmount, warns };
}

/* 抽屜依深度限制（但計價以輸入數量為主，不乘櫃數） */
function refreshDrawerOptionsByDepth(){
  const Dcm = parseInt(depthEl.value || "0", 10);

  if(!(Dcm > 0)){
    drawerCodeEl.disabled = true;
    drawerQtyEl.disabled = true;
    drawerCodeEl.innerHTML = `<option value="">請先輸入深度</option>`;
    drawerCodeEl.value = "";
    return;
  }

  const allowCodes = (Dcm > 60) ? DRAWER_CODES_DEEP : DRAWER_CODES_SHALLOW;

  drawerCodeEl.disabled = false;
  drawerQtyEl.disabled = false;

  const prev = drawerCodeEl.value;

  drawerCodeEl.innerHTML =
    [`<option value="">不需要</option>`].concat(
      allowCodes.map(code=>{
        const row = findByCode(drawersRows, code);
        const name = row?.name || "（表內找不到名稱）";
        const price = row?.price || 0;
        const unit = row?.unit || "組";
        return `<option value="${escapeHtml(code)}">${escapeHtml(code)}｜${escapeHtml(name)}｜${money(price)} / ${escapeHtml(unit)}</option>`;
      })
    ).join("");

  if(prev && !allowCodes.includes(prev)) drawerCodeEl.value = "";
  else drawerCodeEl.value = prev;
}

/* 配件選擇與計價（抽屜/五金：以輸入數量為主；板材：多列累加） */
function getAccessorySelections(){
  const selections = [];
  const warnings = [];

  // 1) 抽屜（不乘櫃數）
  const drawerCode = (drawerCodeEl.value || "").trim();
  if(drawerCode){
    const qty = Math.max(1, parseInt(drawerQtyEl.value || "1", 10));
    const row = findByCode(drawersRows, drawerCode);
    const unitPrice = row?.price || 0;
    const unit = row?.unit || "組";
    const name = row?.name || drawerCode;
    if(!row) warnings.push(`抽屜編碼 ${drawerCode} 在 drawers 分頁找不到（此項以 $0 計）`);
    selections.push({
      category: "抽屜",
      code: drawerCode,
      name,
      unit,
      unitPrice,
      qty,
      qtyMode: `自訂數量`,
      amount: unitPrice * qty
    });
  }

  // 2) 板材/封板（多列，不乘櫃數）
  const { warns: boardWarns } = refreshBoardLinesHints();
  warnings.push(...boardWarns);

  boardLines.forEach(line=>{
    const res = calcBoardLine(line);
    if(res.empty) return;

    selections.push({
      category: "板材/封板",
      code: res.code || (line.code||""),
      name: res.name || (line.code||""),
      unit: "才",
      unitPrice: res.unitPrice || 0,
      qty: res.totalCai || 0,
      qtyMode: res.spec
        ? `(${line.lenCm}×${line.widCm})÷900→進位${res.spec.ceilCaiPerPiece}才/片×${res.spec.pieces}片`
        : "—",
      spec: {
        lenCm: parseFloat(line.lenCm || "0") || 0,
        widCm: parseFloat(line.widCm || "0") || 0,
        pieces: Math.max(1, parseInt(line.pieces || "1", 10)),
        areaCm2: res.spec?.areaCm2 || 0,
        rawCai: res.spec?.rawCai || 0,
        ceilCaiPerPiece: res.spec?.ceilCaiPerPiece || 0
      },
      amount: res.amount || 0
    });
  });

  // 3) 五金（多列、不乘櫃數）
  const { warns: hwWarns } = refreshHardwareLinesHints();
  warnings.push(...hwWarns);

  hardwareLines.forEach(line=>{
    const res = calcHardwareLine(line);
    if(res.empty) return;

    selections.push({
      category: "五金",
      code: res.code || (line.code||""),
      name: res.name || (line.code||""),
      unit: res.unit || "",
      unitPrice: res.unitPrice || 0,
      qty: res.qty || 0,
      qtyMode: `自訂數量`,
      amount: res.amount || 0
    });
  });

  return { selections, warnings };
}

/* 即時計算 */
function updateMatchAndPreview(){
  refreshDrawerOptionsByDepth();

  const kind = cabinetKindEl.value;
  const Hcm = parseInt(heightEl.value || "0", 10);
  const Dcm = parseInt(depthEl.value  || "0", 10);
  const Wcm = parseInt(widthEl.value  || "0", 10);
  const qtySet = Math.max(1, parseInt(qtySetEl.value || "1", 10));

  currentMatch = null;
  currentComputed = null;

  if(!(Hcm>0 && Dcm>0 && Wcm>0)){
    matchHint.textContent = "請輸入高/深/寬（cm），系統會自動匹配價目表並計價。";
    linePreview.textContent = "—";
    const { warnings } = getAccessorySelections();
    setWarn(warnings.length ? warnings.join("；") : "");
    return;
  }

  const Hmm = Hcm * CM_TO_MM;
  const Dmm = Dcm * CM_TO_MM;
  const Wmm = Wcm * CM_TO_MM;

  const best = findBestRate(kind, Hmm, Dmm);
  if(!best){
    matchHint.textContent = "找不到可匹配的櫃體單價（請確認 cabinets 分頁資料）。";
    linePreview.textContent = "—";
    const { warnings } = getAccessorySelections();
    setWarn(warnings.length ? warnings.join("；") : "");
    return;
  }

  const countPerSet = calcCabinetCount(Wmm, best.widthMm);
  const countTotal  = countPerSet * qtySet;
  const baseAmount  = Math.round(best.price * countTotal);

  const { selections, warnings } = getAccessorySelections();
  const accAmount = selections.reduce((s,x)=>s+(x.amount||0),0);
  const totalAmount = baseAmount + accAmount;

  currentMatch = best;
  currentComputed = {
    kind, Hcm, Dcm, Wcm, qtySet,
    countPerSet, countTotal,
    baseAmount,
    accessories: selections,
    accessoryAmount: accAmount,
    totalAmount
  };

  matchHint.textContent =
    `已匹配：${kind}｜高 ${(best.heightMm/10).toFixed(0)} / 深 ${(best.depthMm/10).toFixed(0)} / 寬 ${(best.widthMm/10).toFixed(0)}（來源：[${best.code}]）`;

  const accLine = selections.length
    ? selections.map(a=>`${a.category} ${a.code} ${money(a.unitPrice)}×${a.qty}=${money(a.amount)}`).join("；")
    : "無";

  linePreview.innerHTML =
    `<div>每組櫃數 ${countPerSet} × 組數 ${qtySet} = ${countTotal} 櫃</div>` +
    `<div>櫃體：${money(best.price)} × ${countTotal} = ${money(baseAmount)}</div>` +
    `<div>配件：${escapeHtml(accLine)}</div>` +
    `<div class="mt-1">本項合計：<span class="text-emerald-700">${money(totalAmount)}</span></div>`;

  setWarn(warnings.length ? warnings.join("；") : "");
}

/* 加入購物車 */
document.getElementById("addItemBtn").onclick = () => {
  const name = document.getElementById("cabinetLabel").value.trim() || "櫃體";
  if(!currentMatch || !currentComputed){
    alert("請先輸入完整高/深/寬，並確認已成功匹配單價。");
    return;
  }

  const it = {
    label: name,
    kind: currentComputed.kind,
    input: { heightCm: currentComputed.Hcm, depthCm: currentComputed.Dcm, widthCm: currentComputed.Wcm, qtySet: currentComputed.qtySet },
    matched: {
      code: currentMatch.code,
      name: currentMatch.name,
      heightMm: currentMatch.heightMm,
      depthMm: currentMatch.depthMm,
      widthMm: currentMatch.widthMm,
      unitPrice: currentMatch.price
    },
    countPerSet: currentComputed.countPerSet,
    countTotal: currentComputed.countTotal,
    baseAmount: currentComputed.baseAmount,
    accessories: currentComputed.accessories || [],
    accessoryAmount: currentComputed.accessoryAmount || 0,
    amountTotal: currentComputed.totalAmount || currentComputed.baseAmount
  };

  cartItems.push(it);
  renderCart();
  calcTotal();

  // 加入購物車後清空配件表單（避免誤沿用）
  drawerCodeEl.value = "";
  drawerQtyEl.value = "1";

  boardLines = [];
  renderBoardLines();

  hardwareLines = [];
  renderHardwareLines();

  updateMatchAndPreview();
};

/* 渲染購物車 */
function renderCart(){
  if(!cartItems.length){
    quoteList.innerHTML = `<p class="text-xs text-slate-400">尚未加入任何項目。</p>`;
    return;
  }

  quoteList.innerHTML = cartItems.map((it,i)=>{
    const accHtml = (it.accessories && it.accessories.length)
      ? `<div class="mt-2 border-t pt-2">
          <p class="text-[11px] text-slate-600 font-semibold">配件</p>
          <div class="mt-1 space-y-1">
            ${it.accessories.map(a=>{
              const extra = (a.category === "板材/封板" && a.spec && a.spec.lenCm && a.spec.widCm)
                ? `｜長${a.spec.lenCm}×寬${a.spec.widCm}cm｜${a.spec.ceilCaiPerPiece}才/片×${a.spec.pieces}片`
                : "";
              return `
              <p class="text-[11px] text-slate-600">
                - ${escapeHtml(a.category)}：${escapeHtml(a.code)}｜${escapeHtml(a.name)}
                ｜${money(a.unitPrice)} × ${a.qty}${escapeHtml(a.unit||"")}
                （${escapeHtml(a.qtyMode || "")}${escapeHtml(extra)}）= ${money(a.amount)}
              </p>`;
            }).join("")}
            <p class="text-[11px] text-emerald-700 font-semibold">配件小計：${money(it.accessoryAmount || 0)}</p>
          </div>
        </div>`
      : `<p class="text-[11px] text-slate-500 mt-2">配件：無</p>`;

    return `
    <div class="border rounded-xl px-3 py-2">
      <div class="flex justify-between items-start">
        <div class="text-xs">
          <p class="font-semibold text-slate-800">${escapeHtml(it.label)}（${escapeHtml(it.kind)}）</p>
          <p class="text-[11px] text-slate-500">
            輸入：高 ${it.input.heightCm} / 深 ${it.input.depthCm} / 寬 ${it.input.widthCm} cm｜組數 ${it.input.qtySet}
          </p>
          <p class="text-[11px] text-emerald-700">
            匹配：[${escapeHtml(it.matched.code)}] 高 ${(it.matched.heightMm/10).toFixed(0)} / 深 ${(it.matched.depthMm/10).toFixed(0)} / 寬 ${(it.matched.widthMm/10).toFixed(0)}
            ｜${money(it.matched.unitPrice)} / 櫃
          </p>
          <p class="text-[11px] text-slate-500">
            每組櫃數 ${it.countPerSet} × 組數 ${it.input.qtySet} = ${it.countTotal} 櫃｜櫃體小計 ${money(it.baseAmount)}
          </p>
          ${accHtml}
          <p class="text-[11px] text-slate-800 font-semibold mt-2">
            本項合計：${money(it.amountTotal)}
          </p>
        </div>
        <button data-i="${i}" class="text-red-500 text-[11px] removeBtn">刪除</button>
      </div>
    </div>
    `;
  }).join("");

  document.querySelectorAll(".removeBtn").forEach(btn=>{
    btn.onclick=()=>{
      cartItems.splice(btn.dataset.i,1);
      renderCart();
      calcTotal();
    };
  });
}

/* 總價 */
function calcTotal(){
  if(!cartItems.length){
    subtotalDisplay.textContent="—";
    totalDisplay.textContent="—";
    footerTotal.textContent="—";
    ufAmountDisplay.textContent="+ $0";
    return { subtotal:0, ufFee:0, total:0 };
  }

  const subtotal = cartItems.reduce((s,x)=>s + (x.amountTotal||0), 0);
  subtotalDisplay.textContent = `$${subtotal.toLocaleString()}`;

  let ufFee = 0;
  if(subtotal < 50000) ufFee = 6000;
  ufAmountDisplay.textContent = `+ $${ufFee.toLocaleString()}`;

  const total = subtotal + ufFee;
  totalDisplay.textContent = `$${total.toLocaleString()}`;
  footerTotal.textContent = `$${total.toLocaleString()}`;

  return { subtotal, ufFee, total };
}

/* payload */
function buildPayload(){
  const { subtotal, ufFee, total } = calcTotal();

  const itemsText = cartItems.map((it,i)=>{
    const accText = (it.accessories && it.accessories.length)
      ? it.accessories.map(a=>(
          `   - ${a.category}：${a.code}｜${a.name}｜$${a.unitPrice}/${a.unit||""} × ${a.qty}${a.unit||""}（${a.qtyMode||""}）= $${(a.amount||0).toLocaleString()}`
        )).join("\n")
      : "   - 無";

    return (
      `${i+1}. ${it.label}（${it.kind}）\n` +
      `   輸入：高${it.input.heightCm} 深${it.input.depthCm} 寬${it.input.widthCm}cm｜組數${it.input.qtySet}\n` +
      `   匹配：${it.matched.code}｜高${(it.matched.heightMm/10).toFixed(0)} 深${(it.matched.depthMm/10).toFixed(0)} 寬${(it.matched.widthMm/10).toFixed(0)}｜$${it.matched.unitPrice}/櫃\n` +
      `   櫃數：每組${it.countPerSet} × 組數${it.input.qtySet} = ${it.countTotal}｜櫃體小計：$${(it.baseAmount||0).toLocaleString()}\n` +
      `   配件：\n${accText}\n` +
      `   本項合計：$${(it.amountTotal||0).toLocaleString()}`
    );
  }).join("\n\n");

  return {
    userId,
    customerName: document.getElementById("customerName").value.trim(),
    customerPhone: document.getElementById("customerPhone").value.trim(),
    subtotal,
    ufFee,
    total,
    itemsText,
    itemsRaw: JSON.stringify(cartItems)
  };
}

/* LIFF */
async function initLiff(){
  try{
    await liff.init({ liffId:"2008590887-zkqDbWqb" });

    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: window.location.href });
      return;
    }

    try{
      const profile = await liff.getProfile();
      userId = profile.userId;
    }catch(e){
      const decoded = liff.getDecodedIDToken?.();
      userId = decoded?.sub || null;
    }

    if(!userId){
      const decoded = liff.getDecodedIDToken?.();
      userId = decoded?.sub || null;
    }
  }catch(err){
    console.error("LIFF init failed:", err);
  }
}

/* send */
async function sendToMake(){
  const name = document.getElementById("customerName").value.trim();
  const phone = document.getElementById("customerPhone").value.trim();
  if(!name || !phone){
    alert("請完整填寫：姓名 + 電話");
    return;
  }
  if(!cartItems.length){
    alert("請先加入至少 1 個櫃體項目");
    return;
  }
  if(!userId){
    alert("無法取得 userId，請從 LINE App 開啟頁面，或在外部瀏覽器完成 LINE 登入。");
    return;
  }

  const payload = buildPayload();

  await fetch("https://hook.us2.make.com/ajl0cxe88ppt16rbtvj8rgepu8tredg9",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });

  alert("報價已送出！");
  if(liff.isInClient()) liff.closeWindow();
}

/* INIT */
document.addEventListener("DOMContentLoaded", async ()=>{
  initScale();
  const btn = document.getElementById("fontToggleBtn");
  if(btn) btn.onclick = toggleScale;

  await initLiff();

  try{
    await loadCabinets();
    drawersRows = await loadSimpleTabFromUrl(DRAWERS_CSV);
    boardsRows = await loadSimpleTabFromUrl(BOARDS_CSV);
    hardwaresRows = await loadSimpleTabFromUrl(HARDWARES_CSV);

    buildBoardOptions();
    buildHardwareOptions();

    loadStatus.textContent =
      `已載入：櫃體 ${cabinetRows.length}｜抽屜 ${drawersRows.length}｜板材/封板 ${boardsRows.length}｜五金 ${hardwaresRows.length}`;
  }catch(e){
    console.error(e);
    loadStatus.textContent = "載入失敗：" + (e?.message || e);
    alert(
      "價目表載入失敗：\n" + (e?.message || e) +
      "\n\n請確認：\n1) 該分頁已「發佈為 CSV」\n2) gid 正確\n3) 表頭包含「編碼/名稱/單位/單價/類型」"
    );
  }

  // 初始渲染空狀態
  renderBoardLines();
  renderHardwareLines();

  // 新增列按鈕
  document.getElementById("addBoardLineBtn").onclick = ()=> addBoardLine({ pieces:1 });
  document.getElementById("addHardwareLineBtn").onclick = ()=> addHardwareLine({ qty:1 });

  // 櫃體輸入
  cabinetKindEl.onchange = updateMatchAndPreview;
  heightEl.oninput = updateMatchAndPreview;
  depthEl.oninput  = updateMatchAndPreview;
  widthEl.oninput  = updateMatchAndPreview;
  qtySetEl.oninput = updateMatchAndPreview;

  // 抽屜
  drawerCodeEl.onchange = updateMatchAndPreview;
  drawerQtyEl.oninput = updateMatchAndPreview;

  // 板材多列：事件委派
  boardLinesEl.addEventListener("change", (e)=>{
    const t = e.target;
    if(t.classList.contains("boardCode")){
      const id = t.dataset.id;
      const line = boardLines.find(x=>x.id===id);
      if(line) line.code = t.value;
      updateMatchAndPreview();
    }
  });
  boardLinesEl.addEventListener("input", (e)=>{
    const t = e.target;
    const id = t.dataset.id;
    const line = boardLines.find(x=>x.id===id);
    if(!line) return;

    if(t.classList.contains("boardLen")) line.lenCm = t.value;
    if(t.classList.contains("boardWid")) line.widCm = t.value;
    if(t.classList.contains("boardPieces")) line.pieces = t.value;

    updateMatchAndPreview();
  });
  boardLinesEl.addEventListener("click", (e)=>{
    const t = e.target;
    if(t.classList.contains("removeBoardLine")){
      removeBoardLine(t.dataset.id);
    }
  });

  // 五金多列：事件委派
  hardwareLinesEl.addEventListener("change", (e)=>{
    const t = e.target;
    if(t.classList.contains("hardwareCode")){
      const id = t.dataset.id;
      const line = hardwareLines.find(x=>x.id===id);
      if(line) line.code = t.value;
      updateMatchAndPreview();
    }
  });
  hardwareLinesEl.addEventListener("input", (e)=>{
    const t = e.target;
    if(!t.classList.contains("hardwareQty")) return;
    const id = t.dataset.id;
    const line = hardwareLines.find(x=>x.id===id);
    if(line) line.qty = t.value;
    updateMatchAndPreview();
  });
  hardwareLinesEl.addEventListener("click", (e)=>{
    const t = e.target;
    if(t.classList.contains("removeHardwareLine")){
      removeHardwareLine(t.dataset.id);
    }
  });

  document.getElementById("sendBtn").onclick = sendToMake;

  updateMatchAndPreview();
});
</script>

</body>
</html>
