<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>蝦拼組 系統櫃報價</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { box-sizing: border-box; }
    html, body { height: 100%; -webkit-overflow-scrolling: touch; }
    * { -webkit-tap-highlight-color: transparent; }

    .wood-bg {
      background-image: linear-gradient(135deg, #D6B28F 0%, #F5DEB3 45%, #C59F7B 100%);
    }
    .elevated {
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.25);
    }
  </style>
</head>

<body class="min-h-screen bg-[#0f172a]">
  <div class="max-w-md mx-auto min-h-screen flex flex-col bg-slate-100">

    <!-- HEADER -->
    <header class="relative overflow-hidden">
      <div class="wood-bg h-20 w-full"></div>
      <div class="absolute inset-x-0 bottom-0 h-20 bg-gradient-to-t from-[#022c22] via-[#064e3b]/90 to-transparent"></div>
      <div class="absolute inset-0 flex flex-col justify-end px-4 pb-4">
        <p class="text-xs text-amber-100/90 font-light tracking-[0.25em] mb-1">SYSTEM CABINET QUOTE</p>
        <h1 class="text-2xl font-semibold text-white tracking-wide">
          蝦拼組 <span class="text-emerald-200 text-lg">系統櫃報價</span>
        </h1>
        <p class="text-[11px] text-emerald-100/80 mt-1">以 Google Sheet 價目表驅動</p>
      </div>
    </header>

    <!-- MAIN -->
    <main class="flex-1 overflow-y-auto px-4 pb-28 pt-4 space-y-4">

      <!-- 客戶資訊 -->
      <section class="bg-white rounded-2xl elevated p-4 space-y-3">
        <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
          <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-white text-[11px]">1</span>
          客戶資訊（選填）
        </h2>

        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <label class="block text-xs text-slate-500 mb-1">客戶姓名</label>
            <input id="customerName" type="text"
                   class="w-full border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-emerald-300"
                   placeholder="例如：王設計" />
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">聯絡電話</label>
            <input id="customerPhone" type="tel"
                   class="w-full border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-emerald-300"
                   placeholder="可不填" />
          </div>
        </div>
      </section>

      <!-- 新增報價項目 -->
      <section class="bg-white rounded-2xl elevated p-4 space-y-3">
        <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
          <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-white text-[11px]">2</span>
          新增報價項目
        </h2>

        <p id="loadStatus" class="text-[11px] text-slate-400">正在從 Google Sheet 載入價目表…</p>

        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <label class="block text-xs text-slate-500 mb-1">商品群組</label>
            <select id="groupSelect" class="w-full border rounded-lg px-3 py-2 text-sm">
              <option value="ALL">全部</option>
              <option value="櫃體">櫃體</option>
              <option value="抽屜">抽屜</option>
              <option value="板材/封板">板材／封板</option>
              <option value="五金/加工">五金／加工／電料</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">單位提示</label>
            <p id="unitHint"
               class="text-[11px] text-emerald-700 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-100">
               先選擇商品，再輸入數量
            </p>
          </div>
        </div>

        <div>
          <label class="block text-xs text-slate-500 mb-1">商品項目（來自 Google Sheet）</label>
          <select id="itemSelect"
                  class="w-full border rounded-lg px-3 py-2 text-sm">
            <option value="">載入中…</option>
          </select>
          <p id="itemNote" class="text-[11px] text-slate-400 mt-1"></p>
        </div>

        <div class="grid grid-cols-2 gap-3 text-sm mt-2">
          <div>
            <label class="block text-xs text-slate-500 mb-1">數量</label>
            <input id="qtyInput" type="number" min="0" step="0.1"
                   class="w-full border rounded-lg px-3 py-2 text-sm"
                   placeholder="例如：3、4.5" />
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">單價 × 數量</label>
            <p id="linePreview" class="text-sm font-medium text-slate-800 mt-2">—</p>
          </div>
        </div>

        <button id="addItemBtn"
                class="w-full bg-emerald-700 text-white font-semibold text-sm py-2 rounded-xl shadow-md">
          加入本次報價
        </button>
      </section>

      <!-- 報價清單 -->
      <section class="bg-white rounded-2xl elevated p-4 space-y-3 mb-2">
        <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
          <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-white text-[11px]">3</span>
          報價項目清單
        </h2>

        <div id="quoteList" class="space-y-2 text-sm">
          <p class="text-xs text-slate-400">尚未加入任何項目。</p>
        </div>

        <div class="border-t pt-3 text-sm">
          <div class="flex justify-between">
            <span class="text-slate-600 font-medium">小計</span>
            <span id="subtotalDisplay" class="font-semibold text-slate-800">—</span>
          </div>

          <div class="flex justify-between border-t pt-2 mt-2">
            <span class="text-slate-700 font-semibold">總價</span>
            <span id="totalDisplay" class="text-lg font-bold text-emerald-700">—</span>
          </div>
        </div>
      </section>

    </main>

    <!-- FOOTER -->
    <footer class="fixed bottom-0 left-0 right-0 bg-[#022c22] border-t border-emerald-900/40">
      <div class="max-w-md mx-auto flex justify-between items-center px-4 py-3">
        <div class="text-xs text-emerald-100">
          <p class="font-semibold text-emerald-50">報價總額</p>
          <p id="footerTotal" class="text-lg font-bold text-emerald-300">—</p>
        </div>

        <button id="sendBtn"
                class="flex-1 bg-emerald-500 text-emerald-950 ml-3 py-2 rounded-xl font-semibold shadow-lg">
          傳送報價給 LINE 用戶
        </button>
      </div>
    </footer>
  </div>

<script>
/* -------------------------------
   1. Google Sheet CSV 來源
--------------------------------*/
const SHEET_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?output=csv";

/* -------------------------------
   DOM 元素
--------------------------------*/
const loadStatus = document.getElementById("loadStatus");
const groupSelect = document.getElementById("groupSelect");
const itemSelect = document.getElementById("itemSelect");
const itemNote = document.getElementById("itemNote");
const qtyInput = document.getElementById("qtyInput");
const linePreview = document.getElementById("linePreview");

const quoteList = document.getElementById("quoteList");
const subtotalDisplay = document.getElementById("subtotalDisplay");
const totalDisplay = document.getElementById("totalDisplay");
const footerTotal = document.getElementById("footerTotal");

const customerNameInput = document.getElementById("customerName");
const customerPhoneInput = document.getElementById("customerPhone");

let allItems = [];
let quoteItems = [];

/* -------------------------------
   2. CSV Parser（支援引號/逗號）
--------------------------------*/
function parseCSV(text) {
  const rows = [];
  let cur = "";
  let row = [];
  let inside = false;

  for (let i = 0; i < text.length; i++) {
    let c = text[i];
    let n = text[i + 1];

    if (c === '"' && inside && n === '"') {
      cur += '"';
      i++;
    } else if (c === '"') {
      inside = !inside;
    } else if (c === "," && !inside) {
      row.push(cur);
      cur = "";
    } else if ((c === "\n" || c === "\r") && !inside) {
      if (cur || row.length) {
        row.push(cur);
        rows.push(row);
      }
      row = [];
      cur = "";
    } else {
      cur += c;
    }
  }
  if (cur || row.length) {
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

/* -------------------------------
   3. 商品分類推測
--------------------------------*/
function inferGroup(code) {
  if (/^[1-9]/.test(code)) return "櫃體";
  if (/^D/.test(code)) return "抽屜";
  if (/^(FA|T)/.test(code)) return "板材/封板";
  if (/^(Z|TJ)/.test(code)) return "五金/加工";
  return "其他";
}

/* -------------------------------
   4. 從 Google Sheet 載入
--------------------------------*/
async function loadPriceList() {
  try {
    const res = await fetch(SHEET_CSV_URL);
    const text = await res.text();

    const rows = parseCSV(text);
    const header = rows[0];

    const idxCode = header.indexOf("編碼");
    const idxName = header.indexOf("名稱");
    const idxUnit = header.indexOf("單位");
    const idxPrice = header.indexOf("單價");

    allItems = rows.slice(1).map(r => ({
      code: r[idxCode],
      name: r[idxName],
      unit: r[idxUnit],
      price: parseFloat(r[idxPrice] || 0),
      group: inferGroup(r[idxCode])
    }))
    .filter(x => x.code && x.code !== "UF" && !isNaN(x.price)); // ⛔ UF 直接忽略

    loadStatus.textContent = `已載入 ${allItems.length} 筆價目資料`;

    buildItemOptions();

  } catch (err) {
    console.error(err);
    loadStatus.textContent = "載入失敗，請確認 Google Sheet 已公開";
  }
}

/* -------------------------------
   5. 建立下拉選項
--------------------------------*/
function buildItemOptions() {
  const group = groupSelect.value;
  const list = group === "ALL"
    ? allItems
    : allItems.filter(x => x.group === group);

  if (!list.length) {
    itemSelect.innerHTML = `<option value="">此群組暫無項目</option>`;
    return;
  }

  itemSelect.innerHTML = list.map(
    x => `<option value="${x.code}">[${x.code}] ${x.name}｜${x.unit} $${x.price}</option>`
  ).join("");

  updateUnitHint();
}

function getSelectedItem() {
  return allItems.find(x => x.code === itemSelect.value);
}

function updateUnitHint() {
  const item = getSelectedItem();
  if (!item) return;

  itemNote.textContent = `單位：${item.unit}｜單價：$${item.price}`;
}

/* -------------------------------
   6. 單價 × 數量 預覽
--------------------------------*/
function updateLinePreview() {
  const item = getSelectedItem();
  const qty = parseFloat(qtyInput.value || 0);
  if (!item || qty <= 0) {
    linePreview.textContent = "—";
    return;
  }

  const amount = Math.round(item.price * qty);
  linePreview.textContent = `$${item.price} × ${qty} ≈ $${amount.toLocaleString()}`;
}

/* -------------------------------
   7. 新增項目
--------------------------------*/
function renderQuoteList() {
  if (!quoteItems.length) {
    quoteList.innerHTML = `<p class="text-xs text-slate-400">尚未加入任何項目。</p>`;
    subtotalDisplay.textContent = "—";
    totalDisplay.textContent = "—";
    footerTotal.textContent = "—";
    return;
  }

  quoteList.innerHTML = quoteItems.map((it, i) => `
    <div class="flex justify-between items-start border rounded-xl px-3 py-2">
      <div class="text-xs">
        <p class="font-semibold text-slate-800">[${it.code}] ${it.name}</p>
        <p class="text-[11px] text-slate-500">
          數量：${it.qty} ${it.unit}｜小計 $${it.amount.toLocaleString()}
        </p>
      </div>
      <button class="text-[11px] text-red-500" onclick="removeItem(${i})">刪除</button>
    </div>
  `).join("");

  recalcTotal();
}

function removeItem(i) {
  quoteItems.splice(i, 1);
  renderQuoteList();
}

function recalcTotal() {
  const subtotal = quoteItems.reduce((s, x) => s + x.amount, 0);

  subtotalDisplay.textContent = `$${subtotal.toLocaleString()}`;
  totalDisplay.textContent = `$${subtotal.toLocaleString()}`;
  footerTotal.textContent = `$${subtotal.toLocaleString()}`;
}

/* -------------------------------
   8. 建立報價文字
--------------------------------*/
function buildQuoteText() {
  const name = customerNameInput.value.trim();
  const phone = customerPhoneInput.value.trim();

  const subtotal = quoteItems.reduce((s, x) => s + x.amount, 0);

  const header = [`【蝦拼組 系統櫃報價單】`];
  if (name) header.push(`客戶：${name}`);
  if (phone) header.push(`電話：${phone}`);
  if (name || phone) header.push("");

  const items = quoteItems.map((it, i) => 
    `${i + 1}. [${it.code}] ${it.name}\n  數量：${it.qty} ${it.unit}｜小計：$${it.amount.toLocaleString()}`
  );

  const totalLines = [
    "",
    `小計：$${subtotal.toLocaleString()}`,
    `總價：$${subtotal.toLocaleString()}`,
    "",
    "※ 金額以現場丈量、設計圖、合約為準"
  ];

  return [...header, ...items, ...totalLines].join("\n");
}

/* -------------------------------
   9. LIFF 初始化
--------------------------------*/
async function initLiff() {
  try {
    await liff.init({ liffId: "2008590887-zkqDbWqb" });

    const profile = await liff.getProfile();
    window.userId = profile.userId;

  } catch (err) {
    console.error("LIFF 初始化失敗：", err);
  }
}

/* -------------------------------
   10. 送到 MAKE Webhook
--------------------------------*/
const MAKE_WEBHOOK_URL =
  "https://hook.us2.make.com/rbomljrj7wy2qkhqu3ajeuokqyovltbh";

async function sendToMake() {
  const text = buildQuoteText();

  try {
    await fetch(MAKE_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        to: window.userId,
        message: text,
      }),
    });

    alert("報價已傳送！");
    if (liff.isInClient()) liff.closeWindow();

  } catch (err) {
    alert("傳送失敗");
    console.error(err);
  }
}

/* -------------------------------
   11. 綁定事件 & 初始化
--------------------------------*/
document.addEventListener("DOMContentLoaded", () => {
  initLiff();
  loadPriceList();

  groupSelect.onchange = buildItemOptions;
  itemSelect.onchange = () => {
    updateUnitHint();
    updateLinePreview();
  };
  qtyInput.oninput = updateLinePreview;

  document.getElementById("addItemBtn").onclick = () => {
    const it = getSelectedItem();
    const qty = parseFloat(qtyInput.value || 0);

    if (!it || qty <= 0) return alert("請輸入有效數量");

    const amount = Math.round(it.price * qty);

    quoteItems.push({
      code: it.code,
      name: it.name,
      unit: it.unit,
      qty,
      price: it.price,
      amount,
    });

    qtyInput.value = "";
    updateLinePreview();
    renderQuoteList();
  };

  document.getElementById("sendBtn").onclick = sendToMake;
});
</script>

</body>
</html>
