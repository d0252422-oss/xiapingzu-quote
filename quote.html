<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>拚拼組 系統櫃報價</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{ box-sizing: border-box; background-color: #0f172a; font-family: sans-serif; }
    :root{ --scale: 1.25; }
    html{ font-size: calc(16px * var(--scale)); }
    .wood-bg{ background-image: linear-gradient(135deg,#D6B28F 0%,#F5DEB3 45%,#C59F7B 100%); }
    input, select, button{ font-size: 1rem !important; padding: 0.6rem !important; }
  </style>
</head>

<body class="flex justify-center">
<div class="w-full max-w-md min-h-screen bg-slate-100 flex flex-col">

  <header class="wood-bg h-24 flex flex-col justify-end px-4 pb-3 shadow-md">
    <h1 class="text-white text-xl font-bold">拚拼組 <span class="text-emerald-900">系統櫃報價</span></h1>
    <p class="text-white/80 text-xs font-bold">資料來源：Google Sheets (drawers)</p>
  </header>

  <main class="p-4 space-y-4 mb-32">
    <section class="bg-white rounded-xl p-4 shadow-md space-y-3">
      <input id="customerName" type="text" placeholder="客戶姓名" class="border rounded-lg w-full">
      <div class="grid grid-cols-3 gap-2">
        <input id="heightCm" type="number" placeholder="高(cm)" class="border rounded-lg w-full">
        <input id="depthCm" type="number" placeholder="深(cm)" class="border rounded-lg w-full">
        <input id="widthCm" type="number" placeholder="寬(cm)" class="border rounded-lg w-full">
      </div>
    </section>

    <section class="bg-white rounded-xl p-4 shadow-md space-y-4">
      <div class="border-l-4 border-emerald-500 pl-2">
        <p class="text-sm font-bold text-slate-700">1) 抽屜配件</p>
        <p class="text-[10px] text-slate-400">系統將依深度自動顯示 A 或 B 系列</p>
      </div>
      
      <div class="flex gap-2">
        <select id="drawerCode" class="border rounded-lg flex-1 bg-white text-sm">
          <option value="">請先輸入深度尺寸</option>
        </select>
        <div class="flex items-center gap-1 border rounded-lg px-2">
          <span class="text-xs text-slate-400">數量</span>
          <input id="drawerPerCab" type="number" value="1" class="w-10 text-center outline-none">
        </div>
      </div>
    </section>

    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
      <p id="linePreview" class="text-sm font-bold text-blue-900">等待輸入資料...</p>
    </div>

    <button id="addItemBtn" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">
      加入報價清單
    </button>

    <div id="cartList" class="space-y-2"></div>
  </main>

  <footer class="fixed bottom-0 w-full max-w-md bg-white p-4 flex justify-between items-center border-t shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
    <div>
      <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Estimated Total</p>
      <p id="totalDisplay" class="text-xl font-black text-emerald-600">$ 0</p>
    </div>
    <button id="sendBtn" class="bg-emerald-500 text-white px-8 py-2 rounded-lg font-bold shadow-md active:bg-emerald-600">傳送報價</button>
  </footer>
</div>

<script>
// 直接鎖定您的 CSV 連結
const DRAWER_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=1520827127&single=true&output=csv";
const CABINET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=0&single=true&output=csv";

let drawerData = [];
let cabinetData = [];
let cart = [];

// 解析函數：針對您的 Excel 截圖設計 (A:編碼, B:名稱, D:單價)
function parseDrawerCSV(csvText) {
  const rows = csvText.trim().split('\n').slice(1); // 跳過第一列標題
  return rows.map(row => {
    const cols = row.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
    return {
      code: cols[0] || "",  // A 欄: 編碼
      name: cols[1] || "",  // B 欄: 名稱
      price: parseInt(cols[3]?.replace(/[^\d]/g, '')) || 0 // D 欄: 單價
    };
  }).filter(item => item.code !== "");
}

async function loadSheets() {
  try {
    const [dRes, cRes] = await Promise.all([
      fetch(DRAWER_CSV + "&t=" + Date.now()).then(r => r.text()),
      fetch(CABINET_CSV + "&t=" + Date.now()).then(r => r.text())
    ]);
    drawerData = parseDrawerCSV(dRes);
    console.log("抽屜資料已載入:", drawerData);
    updateDrawerUI();
  } catch (e) {
    alert("Excel 資料讀取失敗，請確認網路連線");
  }
}

function updateDrawerUI() {
  const depth = parseInt(document.getElementById("depthCm").value || 0);
  const select = document.getElementById("drawerCode");
  
  if (depth <= 0) {
    select.innerHTML = '<option value="">請先輸入深度</option>';
    return;
  }

  // 邏輯：深 > 60 用 B 系列，否則用 A 系列
  const filterPrefix = depth > 60 ? "B" : "A";
  const options = drawerData.filter(d => d.code.startsWith(filterPrefix));

  let html = '<option value="">不需要</option>';
  if (options.length === 0) {
    html = '<option value="">(查無對應抽屜資料)</option>';
  } else {
    options.forEach(opt => {
      html += `<option value="${opt.code}">${opt.code} | ${opt.name} | $${opt.price}</option>`;
    });
  }
  select.innerHTML = html;
}

function calculate() {
  updateDrawerUI();
  const dCode = document.getElementById("drawerCode").value;
  const dQty = parseInt(document.getElementById("drawerPerCab").value) || 0;
  
  let currentTotal = 0;
  if (dCode) {
    const match = drawerData.find(d => d.code === dCode);
    if (match) currentTotal = match.price * dQty;
  }
  
  document.getElementById("linePreview").textContent = dCode ? `預計金額：$ ${currentTotal.toLocaleString()}` : "請選擇配件";
  return currentTotal;
}

document.getElementById("addItemBtn").onclick = () => {
  const dCode = document.getElementById("drawerCode").value;
  if (!dCode) return alert("請先選擇抽屜配件");
  
  const match = drawerData.find(d => d.code === dCode);
  const dQty = parseInt(document.getElementById("drawerPerCab").value) || 1;
  
  cart.push({
    name: match.name,
    code: match.code,
    qty: dQty,
    sub: match.price * dQty
  });
  
  renderCart();
};

function renderCart() {
  const list = document.getElementById("cartList");
  let total = 0;
  list.innerHTML = cart.map((item, i) => {
    total += item.sub;
    return `
      <div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center border-l-4 border-slate-800">
        <div>
          <p class="font-bold text-sm">${item.code} ${item.name}</p>
          <p class="text-xs text-slate-400">數量: ${item.qty} | 小計: $${item.sub.toLocaleString()}</p>
        </div>
        <button onclick="cart.splice(${i},1);renderCart();" class="text-red-400 font-bold">✕</button>
      </div>
    `;
  }).join('');
  document.getElementById("totalDisplay").textContent = `$ ${total.toLocaleString()}`;
}

window.onload = async () => {
  await liff.init({ liffId: "2008590887-zkqDbWqb" });
  await loadSheets();
  
  document.getElementById("depthCm").oninput = calculate;
  document.getElementById("drawerCode").onchange = calculate;
  document.getElementById("drawerPerCab").oninput = calculate;
};
</script>
</body>
</html>
