<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>蝦拼組 系統櫃報價</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { box-sizing: border-box; }
    html, body { height: 100%; -webkit-overflow-scrolling: touch; }
    * { -webkit-tap-highlight-color: transparent; }

    .wood-bg {
      background-image: linear-gradient(135deg, #D6B28F 0%, #F5DEB3 45%, #C59F7B 100%);
    }
    .elevated {
      box-shadow: 0 18px 40px rgba(15,23,42,0.25);
    }
  </style>
</head>

<body class="min-h-screen bg-[#0f172a]">
<div class="max-w-md mx-auto min-h-screen flex flex-col bg-slate-100">

  <!-- HEADER -->
  <header class="relative overflow-hidden">
    <div class="wood-bg h-20 w-full"></div>
    <div class="absolute inset-x-0 bottom-0 h-20 bg-gradient-to-t from-[#022c22] via-[#064e3b]/95 to-transparent"></div>
    <div class="absolute inset-0 flex flex-col justify-end px-4 pb-4">
      <p class="text-xs text-amber-100/90 tracking-[0.25em] mb-1">SYSTEM CABINET QUOTE</p>
      <h1 class="text-2xl font-semibold text-white">蝦拼組 <span class="text-emerald-200 text-lg">系統櫃報價</span></h1>
      <p class="text-[11px] text-emerald-100/80 mt-1">深綠工程風｜以 Google Sheet 價目表驅動</p>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 overflow-y-auto px-4 pb-28 pt-4 space-y-4">

    <!-- 客戶資訊 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">1</span>
        客戶資訊（必填）
      </h2>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">客戶姓名（必填）</label>
          <input id="customerName" type="text" required
            class="w-full border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-emerald-300"
            placeholder="例如：王設計" />
        </div>

        <div>
          <label class="block text-xs text-slate-500 mb-1">聯絡電話（必填）</label>
          <input id="customerPhone" type="tel" required
            class="w-full border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-emerald-300"
            placeholder="請輸入電話" />
        </div>
      </div>
    </section>

    <!-- 新增報價 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">2</span>
        新增報價項目
      </h2>

      <p id="loadStatus" class="text-[11px] text-slate-400">正在從 Google Sheet 載入價目表…</p>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">商品群組</label>
          <select id="groupSelect"
            class="w-full border rounded-lg px-3 py-2 text-sm">
            <option value="ALL">全部</option>
            <option value="櫃體">櫃體</option>
            <option value="抽屜">抽屜</option>
            <option value="板材/封板">板材／封板</option>
            <option value="五金/加工">五金／加工／電料</option>
            <option value="其他">其他</option>
          </select>
        </div>

        <div>
          <label class="block text-xs text-slate-500 mb-1">單位提示</label>
          <p id="unitHint"
            class="text-[11px] text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-lg px-2 py-[6px]">
            先選擇商品，再輸入數量
          </p>
        </div>
      </div>

      <div>
        <label class="block text-xs text-slate-500 mb-1">商品項目（來自 Google Sheet）</label>
        <select id="itemSelect"
          class="w-full border rounded-lg px-3 py-2 text-sm">
          <option value="">載入中…</option>
        </select>
        <p id="itemNote" class="text-[11px] text-slate-400 mt-1"></p>
      </div>

      <div class="grid grid-cols-2 gap-3 text-sm mt-2">
        <div>
          <label class="block text-xs text-slate-500 mb-1">數量</label>
          <input id="qtyInput" type="number" min="0" step="0.1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：3、4.5" />
        </div>

        <div class="flex flex-col justify-between">
          <div>
            <span class="block text-xs text-slate-500 mb-1">單價 × 數量</span>
            <p id="linePreview" class="text-sm font-medium text-slate-800">—</p>
          </div>
        </div>
      </div>

      <button id="addItemBtn"
        class="w-full mt-2 bg-emerald-700 text-white text-sm font-semibold py-2 rounded-xl shadow-md active:scale-95 disabled:bg-slate-300 disabled:text-slate-600">
        加入本次報價
      </button>
    </section>

    <!-- 報價清單 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3 mb-2">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">3</span>
        報價項目清單
      </h2>

      <div id="quoteList" class="space-y-2 text-sm">
        <p class="text-xs text-slate-400">尚未加入任何項目。</p>
      </div>

      <div class="border-t pt-2 mt-2 text-sm">
        <div class="flex justify-between items-center">
          <span class="text-slate-600 font-medium">小計</span>
          <span id="subtotalDisplay" class="font-semibold text-slate-800">—</span>
        </div>

        <!-- UF（自動 +6000） -->
        <div class="flex items-center justify-between mt-2 text-xs">
          <span class="text-slate-600">未滿五萬運費工資補貼</span>
          <span id="ufAmountDisplay" class="text-slate-700">+ $0</span>
        </div>

        <div class="flex justify-between items-center mt-2 border-t pt-2">
          <span class="text-slate-700 font-semibold">總價</span>
          <span id="totalDisplay" class="text-lg font-bold text-emerald-700">—</span>
        </div>
      </div>
    </section>

  </main>

  <!-- 底部 -->
  <footer class="fixed bottom-0 left-0 right-0 bg-[#022c22] border-t border-emerald-900/40">
    <div class="max-w-md mx-auto flex items-center justify-between px-4 py-3 gap-3">
      <div class="text-xs text-emerald-100">
        <p class="font-semibold">報價總額</p>
        <p id="footerTotal" class="text-lg font-bold text-emerald-300">—</p>
      </div>

      <button id="sendBtn"
        class="flex-1 bg-emerald-500 text-emerald-950 text-sm font-semibold py-2 rounded-xl shadow-lg active:scale-95">
        傳送報價給 LINE 用戶
      </button>
    </div>
  </footer>
</div>

<script>

/* 四個 Sheet 的 CSV */
const URL_CABINETS =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=0&single=true&output=csv";
const URL_DRAWERS =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=1520827127&single=true&output=csv";
const URL_BOARDS =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=71905260&single=true&output=csv";
const URL_HARDWARES =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=206474142&single=true&output=csv";


const loadStatus = document.getElementById("loadStatus");
const groupSelect = document.getElementById("groupSelect");
const itemSelect = document.getElementById("itemSelect");
const itemNote = document.getElementById("itemNote");
const unitHint = document.getElementById("unitHint");
const qtyInput = document.getElementById("qtyInput");
const linePreview = document.getElementById("linePreview");
const addItemBtn = document.getElementById("addItemBtn");
const quoteList = document.getElementById("quoteList");
const subtotalDisplay = document.getElementById("subtotalDisplay");
const ufAmountDisplay = document.getElementById("ufAmountDisplay");
const totalDisplay = document.getElementById("totalDisplay");
const footerTotal = document.getElementById("footerTotal");
const sendBtn = document.getElementById("sendBtn");

const customerNameInput = document.getElementById("customerName");
const customerPhoneInput = document.getElementById("customerPhone");

let allItems = [];
let quoteItems = [];

/* CSV Parser */
function parseCSV(text) {
  const rows = [];
  let cur = "";
  let row = [];
  let inside = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i], next = text[i + 1];

    if (c === '"' && inside && next === '"') {
      cur += '"'; i++; continue;
    }
    if (c === '"') { inside = !inside; continue; }
    if (c === "," && !inside) { row.push(cur); cur = ""; continue; }
    if ((c === "\n" || c === "\r") && !inside) {
      if (cur || row.length) {
        row.push(cur); rows.push(row); row = []; cur = "";
      }
      continue;
    }
    cur += c;
  }
  if (cur || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

function inferGroup(sheetName) {
  if (sheetName === "cabinets") return "櫃體";
  if (sheetName === "drawers") return "抽屜";
  if (sheetName === "boards") return "板材/封板";
  if (sheetName === "hardwares") return "五金/加工";
  return "其他";
}

/* 載入 4 Sheets */
async function loadPriceList() {
  try {
    const urls = [
      { url: URL_CABINETS, group: "cabinets" },
      { url: URL_DRAWERS, group: "drawers" },
      { url: URL_BOARDS, group: "boards" },
      { url: URL_HARDWARES, group: "hardwares" }
    ];

    let merged = [];

    for (const u of urls) {
      const res = await fetch(u.url + "&rand=" + Math.random());
      const text = await res.text();
      const rows = parseCSV(text);

      const header = rows[0];
      const idxCode = header.indexOf("編碼");
      const idxName = header.indexOf("名稱");
      const idxUnit = header.indexOf("單位");
      const idxPrice = header.indexOf("單價");

      const part = rows.slice(1)
        .map(r => ({
          code: r[idxCode],
          name: r[idxName],
          unit: r[idxUnit],
          price: parseFloat(r[idxPrice] || 0),
          group: inferGroup(u.group)
        }))
        .filter(x => x.code && !isNaN(x.price));

      merged = merged.concat(part);
    }

    allItems = merged;

    loadStatus.textContent = `已載入 ${allItems.length} 筆資料`;
    buildItemOptions();
    updateLinePreview();

  } catch (e) {
    console.error(e);
    loadStatus.textContent = "⚠️ Google Sheet 無法存取";
  }
}

/* 下拉項目 */
function buildItemOptions() {
  const g = groupSelect.value;
  const items = g === "ALL" ? allItems : allItems.filter(x => x.group === g);

  if (!items.length) {
    itemSelect.innerHTML = `<option value="">此群組無資料</option>`;
    return;
  }

  itemSelect.innerHTML = items.map(x =>
    `<option value="${x.code}">[${x.code}] ${x.name}｜${x.unit} $${x.price}</option>`
  ).join("");

  updateUnitHint();
}

function getSelectedItem() {
  return allItems.find(x => x.code === itemSelect.value) || null;
}

function updateUnitHint() {
  const item = getSelectedItem();
  if (!item) {
    unitHint.textContent = "先選擇商品，再輸入數量";
    itemNote.textContent = "";
    return;
  }

  const map = {
    "櫃體": "以「尺」計價",
    "抽屜": "以「組」計價",
    "板材/封板": "以「才」計價",
    "五金/加工": "依單位計價"
  };

  unitHint.textContent = map[item.group] || "";
  itemNote.textContent = `單位：${item.unit}｜單價：$${item.price}`;
}

/* 單價×數量 */
function updateLinePreview() {
  const item = getSelectedItem();
  const qty = parseFloat(qtyInput.value || "0");
  if (!item || qty <= 0) {
    linePreview.textContent = "—";
    return;
  }

  const amount = Math.round(item.price * qty);
  linePreview.textContent = `$${item.price} × ${qty} = $${amount.toLocaleString()}`;
}

/* 報價清單顯示 */
function renderQuoteList() {
  if (!quoteItems.length) {
    quoteList.innerHTML = `<p class="text-xs text-slate-400">尚未加入任何項目。</p>`;
    subtotalDisplay.textContent = "—";
    totalDisplay.textContent = "—";
    footerTotal.textContent = "—";
    ufAmountDisplay.textContent = "+ $0";
    return;
  }

  quoteList.innerHTML = quoteItems.map((it, i) => `
    <div class="flex justify-between items-start border rounded-xl px-3 py-2">
      <div class="text-xs">
        <p class="font-semibold text-slate-800">[${it.code}] ${it.name}</p>
        <p class="text-[11px] text-slate-500">
          數量：${it.qty} ${it.unit}｜小計 $${it.amount.toLocaleString()}
        </p>
      </div>
      <button data-i="${i}" class="text-red-500 text-[11px] removeBtn">刪除</button>
    </div>
  `).join("");

  document.querySelectorAll(".removeBtn").forEach(btn => {
    btn.onclick = () => {
      const idx = btn.dataset.i;
      quoteItems.splice(idx, 1);
      renderQuoteList();
      recalcTotals();
    };
  });

  recalcTotals();
}

/* 計算總價 — UF 自動 +6000 */
function recalcTotals() {
  const subtotal = quoteItems.reduce((s, x) => s + x.amount, 0);
  subtotalDisplay.textContent = `$${subtotal.toLocaleString()}`;

  let ufFee = 0;
  if (subtotal > 0 && subtotal < 50000) {
    ufFee = 6000;  // ← **你要求的 +6000**
  }

  ufAmountDisplay.textContent = `+ $${ufFee.toLocaleString()}`;

  const total = subtotal + ufFee;
  totalDisplay.textContent = `$${total.toLocaleString()}`;
  footerTotal.textContent = `$${total.toLocaleString()}`;
}

/* 建立傳送文字 */
function buildQuoteText() {
  const name = customerNameInput.value.trim();
  const phone = customerPhoneInput.value.trim();

  const subtotal = quoteItems.reduce((s,x)=>s+x.amount,0);
  const ufFee = subtotal < 50000 ? 6000 : 0;
  const total = subtotal + ufFee;

  const head = [
    "【蝦拼組 系統櫃報價單】",
    `客戶：${name}`,
    `電話：${phone}`,
    ""
  ];

  const list = quoteItems.map((it,i)=>
    `${i+1}. [${it.code}] ${it.name}
    數量：${it.qty} ${it.unit}｜小計：$${it.amount.toLocaleString()}`
  );

  const tail = [
    "",
    `小計：$${subtotal.toLocaleString()}`,
    `未滿五萬運費工資補貼：$${ufFee.toLocaleString()}`,
    `總價：$${total.toLocaleString()}`,
    "",
    "※ 實際金額以現場丈量與合約為準。"
  ];

  return [...head,...list,...tail].join("\n");
}

/* LIFF */
async function initLiff() {
  try {
    await liff.init({ liffId: "2008590887-zkqDbWqb" });
  } catch (e) {}
}

async function sendToLine() {
  const name = customerNameInput.value.trim();
  const phone = customerPhoneInput.value.trim();

  if (!name || !phone) {
    alert("⚠️ 客戶姓名與聯絡電話為必填");
    return;
  }

  const text = buildQuoteText();

  if (liff.isInClient()) {
    try {
      await liff.sendMessages([{ type: "text", text }]);
      alert("已傳送報價給 LINE 用戶");
      liff.closeWindow();
    } catch (e) {
      alert("傳送失敗");
    }
  } else {
    alert("目前不在 LINE App，以下為內容預覽：\n\n" + text);
  }
}

/* INIT */
function init() {
  loadPriceList();
  initLiff();

  groupSelect.onchange = buildItemOptions;
  itemSelect.onchange = () => { updateUnitHint(); updateLinePreview(); };
  qtyInput.oninput = updateLinePreview;

  addItemBtn.onclick = () => {
    const item = getSelectedItem();
    const qty = parseFloat(qtyInput.value || "0");
    if (!item || qty <= 0) {
      alert("請選擇商品並輸入數量");
      return;
    }

    const amount = Math.round(item.price * qty);
    quoteItems.push({ ...item, qty, amount });
    qtyInput.value = "";
    updateLinePreview();
    renderQuoteList();
  };

  sendBtn.onclick = sendToLine;
}

document.addEventListener("DOMContentLoaded", init);

</script>

</body>
</html>
