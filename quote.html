<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>拚拼組 系統櫃報價</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body{box-sizing:border-box;}
    html,body{height:100%;-webkit-overflow-scrolling:touch;}
    *{-webkit-tap-highlight-color:transparent;}
    .wood-bg{background-image:linear-gradient(135deg,#D6B28F 0%,#F5DEB3 45%,#C59F7B 100%);}
    .elevated{box-shadow:0 18px 40px rgba(15,23,42,0.25);}

    /* ====== 字體縮放：預設 1.25 倍，可切換到 2 倍 ====== */
    :root{ --scale: 1.25; }
    html{ font-size: calc(16px * var(--scale)); }

    .text-\[11px\]{ font-size: 0.90rem !important; }
    .text-xs{ font-size: 0.98rem !important; }
    .text-sm{ font-size: 1.05rem !important; }

    input, select, button{
      font-size: 1.08rem !important;
      line-height: 1.35 !important;
    }
    input, select{
      padding-top: 0.85rem !important;
      padding-bottom: 0.85rem !important;
    }
    button{
      padding-top: 0.95rem !important;
      padding-bottom: 0.95rem !important;
    }

    .text-slate-400, .text-slate-500{
      color: rgba(71,85,105,0.95) !important;
    }

    #totalDisplay, #footerTotal{
      font-size: 1.45rem !important;
    }
  </style>
</head>

<body class="min-h-screen bg-[#0f172a]">
<div class="max-w-md mx-auto min-h-screen flex flex-col bg-slate-100">

  <!-- HEADER -->
  <header class="relative overflow-hidden">
    <div class="wood-bg h-20 w-full"></div>
    <div class="absolute inset-x-0 bottom-0 h-20 bg-gradient-to-t from-[#022c22] via-[#064e3b]/95 to-transparent"></div>

    <div class="absolute top-3 right-4 z-20">
      <button id="fontToggleBtn"
        class="rounded-xl bg-white/90 backdrop-blur px-3 py-2 text-[11px] font-semibold text-slate-800 border border-white/70 shadow-sm active:scale-95">
        字體：1.25×
      </button>
    </div>

    <div class="absolute inset-0 flex flex-col justify-end px-4 pb-4">
      <p class="text-xs text-amber-100/90 tracking-[0.25em] mb-1">SYSTEM CABINET QUOTE</p>
      <h1 class="text-2xl font-semibold text-white">拚拼組 <span class="text-emerald-200 text-lg">系統櫃報價</span></h1>
      <p class="text-[11px] text-emerald-100/80 mt-1">輸入高/深/寬加入購物車｜配件可選（抽屜/板材/五金加工）</p>
    </div>
  </header>

  <main class="flex-1 overflow-y-auto px-4 pb-56 pt-4 space-y-4">

    <!-- 客戶資訊 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">1</span>
        客戶資訊（必填）
      </h2>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">客戶姓名</label>
          <input id="customerName" required type="text"
            class="w-full border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-emerald-300"
            placeholder="例如：王設計" />
        </div>

        <div>
          <label class="block text-xs text-slate-500 mb-1">聯絡電話</label>
          <input id="customerPhone" required type="tel"
            class="w-full border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-emerald-300"
            placeholder="必填" />
        </div>
      </div>
    </section>

    <!-- 新增櫃體 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">2</span>
        新增櫃體（輸入高/深/寬）
      </h2>

      <p id="loadStatus" class="text-[11px] text-slate-400">正在載入價目表…</p>
      <p id="loadStatus2" class="text-[11px] text-slate-400">—</p>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">櫃體名稱（可選）</label>
          <input id="cabinetLabel" type="text"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：衣櫃 / 玄關櫃" />
        </div>

        <div>
          <label class="block text-xs text-slate-500 mb-1">櫃體類型</label>
          <select id="cabinetKind" class="w-full border rounded-lg px-3 py-2 text-sm">
            <option value="開門櫃">開門櫃</option>
            <option value="空櫃">空櫃</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">高度（cm）</label>
          <input id="heightCm" type="number" min="0" step="1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：210" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">深度（cm）</label>
          <input id="depthCm" type="number" min="0" step="1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：53" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">寬度（cm）</label>
          <input id="widthCm" type="number" min="0" step="1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：340" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">數量（組）</label>
          <input id="qtySet" type="number" min="1" step="1" value="1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：1" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">計價說明</label>
          <p class="text-[11px] text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-lg px-2 py-[6px]">
            寬度以表內寬度換算櫃數（不足一櫃補一櫃）
          </p>
        </div>
      </div>

      <div class="border rounded-xl px-3 py-2 bg-slate-50">
        <p class="text-xs text-slate-600 font-medium">即時計算</p>
        <p id="matchHint" class="text-[11px] text-slate-500 mt-1">請輸入高/深/寬（cm），系統會自動匹配價目表並計價。</p>
        <p id="linePreview" class="text-sm font-semibold text-slate-800 mt-1">—</p>
        <p id="addonPreview" class="text-[11px] text-slate-600 mt-1">配件試算：—</p>
      </div>

      <!-- 配件 -->
      <section class="border rounded-2xl p-3 bg-white space-y-3">
        <h3 class="text-sm font-semibold text-slate-700">配件（可選）</h3>

        <!-- 1) 抽屜 -->
        <div class="border rounded-xl p-3 bg-slate-50 space-y-2">
          <div class="flex items-center justify-between">
            <p class="font-semibold text-slate-700">1) 抽屜</p>
            <p id="drawerRuleHint" class="text-[11px] text-slate-500">依深度限制選項</p>
          </div>

          <label class="block text-xs text-slate-500">抽屜型號</label>
          <select id="drawerCode" class="w-full border rounded-lg px-3 py-2 text-sm bg-white">
            <option value="">不需要</option>
          </select>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs text-slate-500 mb-1">數量（組）</label>
              <input id="drawerQty" type="number" min="1" step="1" value="1"
                class="w-full border rounded-lg px-3 py-2 text-sm bg-white" />
            </div>
            <div class="text-xs text-slate-700 bg-white border rounded-lg px-3 py-2">
              <p>小計</p>
              <p id="drawerAmount" class="font-semibold text-emerald-700">$0</p>
            </div>
          </div>
          <p id="drawerMeta" class="text-[11px] text-slate-600">—</p>
        </div>

        <!-- 2) 板材 -->
        <div class="border rounded-xl p-3 bg-slate-50 space-y-2">
          <div class="flex items-center justify-between">
            <p class="font-semibold text-slate-700">2) 板材封板（才數計價）</p>
            <p class="text-[11px] text-slate-500">1才 = 900平方公分</p>
          </div>

          <div id="boardRows" class="space-y-2"></div>

          <button id="addBoardRowBtn" type="button"
            class="w-full bg-white border border-slate-200 text-slate-800 text-sm font-semibold rounded-xl shadow-sm active:scale-95">
            + 新增板材列
          </button>

          <div class="text-xs text-slate-700 bg-white border rounded-lg px-3 py-2">
            <p>板材小計</p>
            <p id="boardsAmount" class="font-semibold text-emerald-700">$0</p>
          </div>
        </div>

        <!-- 3) 五金/加工 -->
        <div class="border rounded-xl p-3 bg-slate-50 space-y-2">
          <div class="flex items-center justify-between">
            <p class="font-semibold text-slate-700">3) 五金與加工（多列）</p>
            <p class="text-[11px] text-slate-500">依數量計價</p>
          </div>

          <div id="hwRows" class="space-y-2"></div>

          <button id="addHwRowBtn" type="button"
            class="w-full bg-white border border-slate-200 text-slate-800 text-sm font-semibold rounded-xl shadow-sm active:scale-95">
            + 新增五金/加工列
          </button>

          <div class="text-xs text-slate-700 bg-white border rounded-lg px-3 py-2">
            <p>五金/加工小計</p>
            <p id="hwAmount" class="font-semibold text-emerald-700">$0</p>
          </div>
        </div>

      </section>

      <button id="addItemBtn"
        class="w-full mt-2 bg-emerald-700 text-white text-sm font-semibold py-2 rounded-xl shadow-md active:scale-95">
        加入購物車
      </button>
    </section>

    <!-- 購物車 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3 mb-2">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">3</span>
        購物車（櫃體＋配件）
      </h2>

      <div id="quoteList" class="space-y-2 text-sm">
        <p class="text-xs text-slate-400">尚未加入任何項目。</p>
      </div>

      <div class="border-t pt-2 mt-2 text-sm">
        <div class="flex justify-between items-center">
          <span class="text-slate-600 font-medium">小計</span>
          <span id="subtotalDisplay" class="font-semibold text-slate-800">—</span>
        </div>

        <div class="flex items-center justify-between mt-2 text-xs">
          <span class="text-slate-600">未滿五萬運費工資補貼</span>
          <span id="ufAmountDisplay" class="text-slate-700">+ $0</span>
        </div>

        <div class="flex justify-between items-center mt-2 border-t pt-2">
          <span class="text-slate-700 font-semibold">總價</span>
          <span id="totalDisplay" class="text-lg font-bold text-emerald-700">—</span>
        </div>
      </div>
    </section>

  </main>

  <!-- 底部 -->
  <footer class="fixed bottom-0 left-0 right-0 bg-[#022c22] border-t border-emerald-900/40">
    <div class="max-w-md mx-auto flex items-center justify-between px-4 py-3 gap-3">
      <div class="text-xs text-emerald-100">
        <p class="font-semibold">報價總額</p>
        <p id="footerTotal" class="text-lg font-bold text-emerald-300">—</p>
      </div>

      <button id="sendBtn"
        class="flex-1 bg-emerald-500 text-emerald-950 text-sm font-semibold py-2 rounded-xl shadow-lg active:scale-95">
        傳送報價
      </button>
    </div>
  </footer>

</div>

<script>
/* ========= CSV 連結 ========= */
const CABINETS_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=0&single=true&output=csv";

const DRAWERS_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=1520827127&single=true&output=csv";

const BOARDS_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=71905260&single=true&output=csv";

const HARDWARES_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=206474142&single=true&output=csv";

/* 你提供的表：高度/深度/寬度皆為 mm；使用者輸入 cm，所以需 ×10 */
const CM_TO_MM = 10;
/* 板材：1 才 = 900 平方公分 */
const ONE_CAI_AREA_CM2 = 900;

let cabinetRows = [];   // 櫃體
let drawerRows = [];    // 抽屜
let boardRows = [];     // 板材
let hardwareRows = [];  // 五金/加工

let cartItems = [];
let userId = null;

/* ===== 字體切換（1.25x / 2x）===== */
const SCALE_SMALL = 1.25;
const SCALE_LARGE = 2.0;
const SCALE_KEY = "pinpin_font_scale";

function applyScale(scale){
  const s = (scale === SCALE_LARGE ? SCALE_LARGE : SCALE_SMALL);
  document.documentElement.style.setProperty("--scale", String(s));
  try{ localStorage.setItem(SCALE_KEY, String(s)); }catch(e){}
  const btn = document.getElementById("fontToggleBtn");
  if(btn) btn.textContent = `字體：${s === 2 ? "2×" : "1.25×"}`;
}
function initScale(){
  let saved = null;
  try{ saved = parseFloat(localStorage.getItem(SCALE_KEY)); }catch(e){}
  if(saved === SCALE_LARGE) applyScale(SCALE_LARGE);
  else applyScale(SCALE_SMALL);
}
function toggleScale(){
  const cur = getComputedStyle(document.documentElement).getPropertyValue("--scale").trim();
  const curNum = parseFloat(cur);
  if(curNum >= 1.8) applyScale(SCALE_SMALL);
  else applyScale(SCALE_LARGE);
}

/* ===== CSV ===== */
function parseCSV(text){
  const quotes=/^"|"$/g;
  return text.trim().split(/\r?\n/).map(r =>
    r.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(v=>v.replace(quotes,"").trim())
  );
}

async function fetchCsv(url){
  const finalUrl = url + (url.includes("?") ? "&" : "?") + "rand=" + Math.random();
  const res = await fetch(finalUrl, { method:"GET" });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    const hint = (t && t.length) ? t.slice(0,200) : "";
    const err = new Error(`HTTP ${res.status} ${res.statusText}`);
    err.status = res.status;
    err.url = url;
    err.hint = hint;
    throw err;
  }
  return await res.text();
}

function headerIndex(headerArr, key){
  const norm = headerArr.map(h => String(h||"").replace(/\uFEFF/g,"").trim().replace(/\s+/g,""));
  const i = norm.indexOf(key);
  return i;
}

async function loadSimpleTab(url){
  const text = await fetchCsv(url);
  const rows = parseCSV(text);
  if(!rows.length) throw new Error("CSV 空資料：" + url);

  const header = rows[0].map(x=>String(x||"").replace(/\uFEFF/g,"").trim());
  const idxCode  = headerIndex(header, "編碼");
  const idxName  = headerIndex(header, "名稱");
  const idxUnit  = headerIndex(header, "單位");
  const idxPrice = headerIndex(header, "單價");
  const idxType  = headerIndex(header, "類型");

  if([idxCode, idxName, idxUnit, idxPrice, idxType].some(i => i < 0)){
    throw new Error(
      "表頭欄位不足（需要：編碼/名稱/單位/單價/類型）。\n" +
      "目前表頭：" + header.join("｜") + "\n連結：" + url
    );
  }

  return rows.slice(1).map(r => {
    const code = (r[idxCode] || "").trim();
    const name = (r[idxName] || "").trim();
    const unit = (r[idxUnit] || "").trim();
    const price = parseInt((r[idxPrice] || "0").toString().replace(/[^0-9]/g,""), 10) || 0;
    const type  = (r[idxType] || "").trim();
    return { code, name, unit, price, type };
  }).filter(x => x.code);
}

/* ===== 櫃體表：高度/深度/寬度皆以 mm 存放 ===== */
async function loadCabinetSheet(){
  const text = await fetchCsv(CABINETS_CSV);
  const rows = parseCSV(text);
  const header = rows[0].map(x=>String(x||"").replace(/\uFEFF/g,"").trim());

  const idxCode  = headerIndex(header,"編碼");
  const idxName  = headerIndex(header,"名稱");
  const idxH     = headerIndex(header,"高度");
  const idxD     = headerIndex(header,"深度");
  const idxW     = headerIndex(header,"寬度");
  const idxPrice = headerIndex(header,"單價");
  const idxType  = headerIndex(header,"類型");

  if([idxCode,idxName,idxH,idxD,idxW,idxPrice,idxType].some(i=>i<0)){
    throw new Error(
      "櫃體表表頭欄位不足（需要：編碼/名稱/高度/深度/寬度/單價/類型）。\n" +
      "目前表頭：" + header.join("｜")
    );
  }

  cabinetRows = rows.slice(1).map(r => {
    const code = (r[idxCode] || "").trim();
    const name = (r[idxName] || "").trim();

    const heightMm = parseInt((r[idxH] || "0").replace(/[^0-9]/g,""), 10) || 0;
    const depthMm  = parseInt((r[idxD] || "0").replace(/[^0-9]/g,""), 10) || 0;
    const widthMm  = parseInt((r[idxW] || "0").replace(/[^0-9]/g,""), 10) || 0;

    const price = parseInt((r[idxPrice] || "0").toString().replace(/[^0-9]/g,""), 10) || 0;
    const type  = (r[idxType] || "").trim();

    return { code, name, heightMm, depthMm, widthMm, price, type };
  }).filter(x =>
    x.code &&
    x.type === "櫃體" &&
    x.price > 0 &&
    x.heightMm > 0 &&
    x.depthMm > 0 &&
    x.widthMm > 0
  );
}

/* ===== 櫃數計算：mm 整數運算（不足一櫃補一櫃） ===== */
function calcCabinetCount(totalWidthMm, baseWidthMm){
  const total = parseInt(totalWidthMm || "0", 10);
  const base  = parseInt(baseWidthMm  || "0", 10);
  if(!(total > 0 && base > 0)) return 0;
  const quotient  = Math.floor(total / base);
  const remainder = total % base;
  return quotient + (remainder > 0 ? 1 : 0);
}

/* ===== 匹配 ===== */
function findBestRate(kind, inputHeightMm, inputDepthMm){
  const poolKind = cabinetRows.filter(x => x.name.includes(kind));
  const candidates = poolKind.length ? poolKind : cabinetRows;

  let heightPool = candidates.filter(x => x.heightMm === inputHeightMm);
  if(!heightPool.length){
    const sorted = candidates.slice().sort((a,b)=>Math.abs(a.heightMm-inputHeightMm)-Math.abs(b.heightMm-inputHeightMm));
    const pickH = sorted[0]?.heightMm;
    heightPool = pickH ? candidates.filter(x => x.heightMm === pickH) : [];
  }
  if(!heightPool.length) return null;

  const depthSorted = heightPool.slice().sort((a,b)=>a.depthMm-b.depthMm);
  let best = depthSorted.find(x => x.depthMm >= inputDepthMm);
  if(!best) best = depthSorted[depthSorted.length-1] || null;

  return best;
}

/* ===== DOM ===== */
const cabinetKindEl = document.getElementById("cabinetKind");
const heightEl = document.getElementById("heightCm");
const depthEl  = document.getElementById("depthCm");
const widthEl  = document.getElementById("widthCm");
const qtySetEl = document.getElementById("qtySet");

const matchHint = document.getElementById("matchHint");
const linePreview = document.getElementById("linePreview");
const addonPreview = document.getElementById("addonPreview");

const quoteList = document.getElementById("quoteList");
const subtotalDisplay = document.getElementById("subtotalDisplay");
const ufAmountDisplay = document.getElementById("ufAmountDisplay");
const totalDisplay = document.getElementById("totalDisplay");
const footerTotal = document.getElementById("footerTotal");

const drawerCodeEl = document.getElementById("drawerCode");
const drawerQtyEl = document.getElementById("drawerQty");
const drawerAmountEl = document.getElementById("drawerAmount");
const drawerMetaEl = document.getElementById("drawerMeta");
const drawerRuleHint = document.getElementById("drawerRuleHint");

const boardRowsEl = document.getElementById("boardRows");
const boardsAmountEl = document.getElementById("boardsAmount");

const hwRowsEl = document.getElementById("hwRows");
const hwAmountEl = document.getElementById("hwAmount");

let currentMatch = null;
let currentComputed = null;

function money(n){ return `$${(n||0).toLocaleString()}`; }

function findByCode(list, code){
  const c = String(code||"").trim();
  return list.find(x => String(x.code||"").trim() === c) || null;
}

/* ===== 抽屜：依深度限制 ===== */
function allowedDrawerCodes(depthCm){
  const d = parseFloat(depthCm || "0");
  if(d > 60) return ["B1","B2","B3"];
  return ["A1","A2","A3"];
}

function refreshDrawerOptions(){
  const Dcm = parseFloat(depthEl.value || "0");
  const codes = allowedDrawerCodes(Dcm);

  drawerRuleHint.textContent = (Dcm > 60)
    ? "深度 > 60：僅可選 B1/B2/B3"
    : "深度 ≤ 60：僅可選 A1/A2/A3";

  const keep = drawerCodeEl.value;
  drawerCodeEl.innerHTML = `<option value="">不需要</option>` + codes.map(code=>{
    const row = findByCode(drawerRows, code);
    const name = row?.name || "（價目表未載入或名稱缺失）";
    return `<option value="${code}">${code}｜${name}</option>`;
  }).join("");

  if(keep && codes.includes(keep)) drawerCodeEl.value = keep;
  else drawerCodeEl.value = "";

  updateAddonPreview();
}

function calcDrawer(){
  const code = drawerCodeEl.value.trim();
  if(!code) return { code:"", qty:0, unit:"", unitPrice:0, name:"", amount:0 };

  const row = findByCode(drawerRows, code);
  const qty = Math.max(1, parseInt(drawerQtyEl.value || "1", 10));
  const unitPrice = row?.price || 0;
  const amount = unitPrice * qty;
  return { code, qty, unit: row?.unit || "組", unitPrice, name: row?.name || "", amount };
}

/* ===== 板材：多列（才數=ceil(長*寬*片數/900)） ===== */
let boardRowId = 0;
let boardLines = []; // {id, code, lengthCm, widthCm, pieces}

function addBoardLine(){
  boardLines.push({ id: ++boardRowId, code:"", lengthCm:"", widthCm:"", pieces:"1" });
  renderBoardLines();
  updateAddonPreview();
}
function removeBoardLine(id){
  boardLines = boardLines.filter(x => x.id !== id);
  renderBoardLines();
  updateAddonPreview();
}
function renderBoardLines(){
  if(!boardLines.length){
    boardRowsEl.innerHTML = `<p class="text-[11px] text-slate-500">尚未新增板材列（可按「新增板材列」）。</p>`;
    return;
  }

  const options = boardRows
    .filter(x => x.price > 0)
    .map(x => `<option value="${x.code}">${x.code}｜${x.name}（${x.unit} $${x.price}）</option>`)
    .join("");

  boardRowsEl.innerHTML = boardLines.map(line=>{
    return `
      <div class="border rounded-xl p-2 bg-white">
        <div class="grid grid-cols-2 gap-2">
          <div class="col-span-2">
            <label class="block text-xs text-slate-500 mb-1">板材品項</label>
            <select data-k="code" data-id="${line.id}" class="w-full border rounded-lg px-3 py-2 bg-white">
              <option value="">請選擇</option>
              ${options}
            </select>
          </div>

          <div>
            <label class="block text-xs text-slate-500 mb-1">長（cm）</label>
            <input data-k="lengthCm" data-id="${line.id}" type="number" min="0" step="0.1"
              class="w-full border rounded-lg px-3 py-2 bg-white" placeholder="例如：40" value="${line.lengthCm}">
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">寬（cm）</label>
            <input data-k="widthCm" data-id="${line.id}" type="number" min="0" step="0.1"
              class="w-full border rounded-lg px-3 py-2 bg-white" placeholder="例如：40" value="${line.widthCm}">
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">片數</label>
            <input data-k="pieces" data-id="${line.id}" type="number" min="1" step="1"
              class="w-full border rounded-lg px-3 py-2 bg-white" value="${line.pieces || "1"}">
          </div>
          <div class="text-xs text-slate-700 bg-slate-50 border rounded-lg px-3 py-2">
            <p>才數 / 小計</p>
            <p id="boardLineMeta_${line.id}" class="font-semibold text-emerald-700">—</p>
          </div>

          <div class="col-span-2">
            <button type="button" data-del="${line.id}" class="w-full text-red-600 border border-red-200 bg-white rounded-xl font-semibold active:scale-95">
              刪除此列
            </button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  // bind
  boardRowsEl.querySelectorAll("select[data-k], input[data-k]").forEach(el=>{
    el.oninput = () => {
      const id = parseInt(el.dataset.id, 10);
      const k = el.dataset.k;
      const line = boardLines.find(x => x.id === id);
      if(!line) return;
      line[k] = el.value;
      updateAddonPreview();
      renderBoardLineMeta(id);
    };
    // 初始化 select value
    if(el.tagName === "SELECT"){
      const id = parseInt(el.dataset.id, 10);
      const line = boardLines.find(x => x.id === id);
      if(line) el.value = line.code || "";
    }
  });

  boardRowsEl.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.onclick = () => removeBoardLine(parseInt(btn.dataset.del,10));
  });

  // render metas
  boardLines.forEach(l => renderBoardLineMeta(l.id));
}

function calcBoardLine(line){
  const code = String(line.code||"").trim();
  const row = code ? findByCode(boardRows, code) : null;
  const unitPrice = row?.price || 0;

  const L = parseFloat(line.lengthCm || "0");
  const W = parseFloat(line.widthCm || "0");
  const pieces = Math.max(1, parseInt(line.pieces || "1", 10));

  const area = (L>0 && W>0) ? (L * W * pieces) : 0; // cm2
  const cai = area > 0 ? Math.ceil(area / ONE_CAI_AREA_CM2) : 0;
  const amount = cai * unitPrice;

  return {
    code,
    name: row?.name || "",
    unit: row?.unit || "才",
    unitPrice,
    lengthCm: L,
    widthCm: W,
    pieces,
    areaCm2: area,
    cai,
    amount
  };
}

function renderBoardLineMeta(id){
  const line = boardLines.find(x => x.id === id);
  if(!line) return;
  const r = calcBoardLine(line);
  const el = document.getElementById(`boardLineMeta_${id}`);
  if(!el) return;

  if(!r.code){
    el.textContent = "請先選品項";
    return;
  }
  if(!(r.lengthCm>0 && r.widthCm>0)){
    el.textContent = `—`;
    return;
  }
  el.textContent = `${r.cai} 才｜${money(r.amount)}`;
}

/* ===== 五金/加工：多列 ===== */
let hwRowId = 0;
let hwLines = []; // {id, code, qty}

function addHwLine(){
  hwLines.push({ id: ++hwRowId, code:"", qty:"1" });
  renderHwLines();
  updateAddonPreview();
}
function removeHwLine(id){
  hwLines = hwLines.filter(x => x.id !== id);
  renderHwLines();
  updateAddonPreview();
}

function renderHwLines(){
  if(!hwLines.length){
    hwRowsEl.innerHTML = `<p class="text-[11px] text-slate-500">尚未新增五金/加工列（可按「新增五金/加工列」）。</p>`;
    return;
  }

  // 依類型分組（五金/加工/電料...），方便挑選
  const groups = {};
  hardwareRows.forEach(x=>{
    const g = x.type || "其他";
    if(!groups[g]) groups[g] = [];
    groups[g].push(x);
  });

  const optionHtml = Object.keys(groups).sort().map(g=>{
    const opts = groups[g].map(x=>(
      `<option value="${x.code}">${x.code}｜${x.name}（${x.unit} $${x.price}）</option>`
    )).join("");
    return `<optgroup label="${g}">${opts}</optgroup>`;
  }).join("");

  hwRowsEl.innerHTML = hwLines.map(line=>{
    return `
      <div class="border rounded-xl p-2 bg-white">
        <div class="grid grid-cols-2 gap-2">
          <div class="col-span-2">
            <label class="block text-xs text-slate-500 mb-1">品項</label>
            <select data-k="code" data-id="${line.id}" class="w-full border rounded-lg px-3 py-2 bg-white">
              <option value="">請選擇</option>
              ${optionHtml}
            </select>
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">數量</label>
            <input data-k="qty" data-id="${line.id}" type="number" min="0" step="1"
              class="w-full border rounded-lg px-3 py-2 bg-white" value="${line.qty || "1"}">
          </div>
          <div class="text-xs text-slate-700 bg-slate-50 border rounded-lg px-3 py-2">
            <p>單位 / 小計</p>
            <p id="hwLineMeta_${line.id}" class="font-semibold text-emerald-700">—</p>
          </div>

          <div class="col-span-2">
            <button type="button" data-del="${line.id}" class="w-full text-red-600 border border-red-200 bg-white rounded-xl font-semibold active:scale-95">
              刪除此列
            </button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  hwRowsEl.querySelectorAll("select[data-k], input[data-k]").forEach(el=>{
    el.oninput = () => {
      const id = parseInt(el.dataset.id,10);
      const k = el.dataset.k;
      const line = hwLines.find(x => x.id === id);
      if(!line) return;
      line[k] = el.value;
      updateAddonPreview();
      renderHwLineMeta(id);
    };
    if(el.tagName === "SELECT"){
      const id = parseInt(el.dataset.id,10);
      const line = hwLines.find(x => x.id === id);
      if(line) el.value = line.code || "";
    }
  });

  hwRowsEl.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.onclick = () => removeHwLine(parseInt(btn.dataset.del,10));
  });

  hwLines.forEach(l => renderHwLineMeta(l.id));
}

function calcHwLine(line){
  const code = String(line.code||"").trim();
  const row = code ? findByCode(hardwareRows, code) : null;
  const unitPrice = row?.price || 0;
  const qty = Math.max(0, parseFloat(line.qty || "0"));
  const amount = Math.round(unitPrice * qty);
  return {
    code,
    name: row?.name || "",
    unit: row?.unit || "",
    unitPrice,
    qty,
    type: row?.type || "",
    amount
  };
}

function renderHwLineMeta(id){
  const line = hwLines.find(x => x.id === id);
  if(!line) return;
  const r = calcHwLine(line);
  const el = document.getElementById(`hwLineMeta_${id}`);
  if(!el) return;

  if(!r.code){
    el.textContent = "請先選品項";
    return;
  }
  el.textContent = `${r.unit || "—"}｜${money(r.amount)}`;
}

/* ===== 配件總計 ===== */
function calcBoardsTotal(){
  return boardLines.reduce((s,l)=> s + (calcBoardLine(l).amount||0), 0);
}
function calcHwTotal(){
  return hwLines.reduce((s,l)=> s + (calcHwLine(l).amount||0), 0);
}

function updateAddonPreview(){
  const dr = calcDrawer();
  const boardsTotal = calcBoardsTotal();
  const hwTotal = calcHwTotal();

  drawerAmountEl.textContent = money(dr.amount);
  if(dr.code){
    drawerMetaEl.textContent = `${dr.code}｜${dr.name || "—"}｜$${dr.unitPrice.toLocaleString()}/${dr.unit || "組"} × ${dr.qty} = ${money(dr.amount)}`;
  }else{
    drawerMetaEl.textContent = "不需要抽屜";
  }

  boardsAmountEl.textContent = money(boardsTotal);
  hwAmountEl.textContent = money(hwTotal);

  const sum = dr.amount + boardsTotal + hwTotal;
  addonPreview.textContent = `配件試算：抽屜 ${money(dr.amount)}｜板材 ${money(boardsTotal)}｜五金/加工 ${money(hwTotal)}｜合計 ${money(sum)}`;
}

/* ===== 即時計算（櫃體 + 配件試算） ===== */
function updateMatchAndPreview(){
  const kind = cabinetKindEl.value;
  const Hcm = parseInt(heightEl.value || "0", 10);
  const Dcm = parseInt(depthEl.value  || "0", 10);
  const Wcm = parseInt(widthEl.value  || "0", 10);
  const qtySet = Math.max(1, parseInt(qtySetEl.value || "1", 10));

  currentMatch = null;
  currentComputed = null;

  refreshDrawerOptions();
  updateAddonPreview();

  if(!(Hcm>0 && Dcm>0 && Wcm>0)){
    matchHint.textContent = "請輸入高/深/寬（cm），系統會自動匹配價目表並計價。";
    linePreview.textContent = "—";
    return;
  }

  const Hmm = Hcm * CM_TO_MM;
  const Dmm = Dcm * CM_TO_MM;
  const Wmm = Wcm * CM_TO_MM;

  const best = findBestRate(kind, Hmm, Dmm);
  if(!best){
    matchHint.textContent = "找不到可匹配的櫃體單價（請確認價目表資料）。";
    linePreview.textContent = "—";
    return;
  }

  const countPerSet = calcCabinetCount(Wmm, best.widthMm);
  const countTotal  = countPerSet * qtySet;
  const amount      = Math.round(best.price * countTotal);

  currentMatch = best;
  currentComputed = { kind, Hcm, Dcm, Wcm, qtySet, countPerSet, countTotal, amount };

  matchHint.textContent =
    `已匹配：${kind}｜高 ${(best.heightMm/10).toFixed(0)} / 深 ${(best.depthMm/10).toFixed(0)} / 寬 ${(best.widthMm/10).toFixed(0)}（來源：[${best.code}]）`;

  linePreview.textContent =
    `每組櫃數 ${countPerSet}（寬${(best.widthMm/10).toFixed(0)}cm）× 組數 ${qtySet} = ${countTotal} 櫃｜$${best.price.toLocaleString()} × ${countTotal} = $${amount.toLocaleString()}`;
}

/* ===== 加入購物車 ===== */
document.getElementById("addItemBtn").onclick = () => {
  const name = document.getElementById("cabinetLabel").value.trim() || "櫃體";
  if(!currentMatch || !currentComputed){
    alert("請先輸入完整高/深/寬，並確認已成功匹配單價。");
    return;
  }

  // 配件計算（注意：抽屜/板材/五金 皆以使用者輸入數量計價，不乘上櫃數）
  const dr = calcDrawer();
  const bLines = boardLines.map(l => calcBoardLine(l)).filter(x => x.code);
  const hLines = hwLines.map(l => calcHwLine(l)).filter(x => x.code);

  const boardsTotal = bLines.reduce((s,x)=>s+(x.amount||0),0);
  const hwTotal = hLines.reduce((s,x)=>s+(x.amount||0),0);
  const addonsTotal = (dr.amount||0) + boardsTotal + hwTotal;

  const baseAmount = currentComputed.amount;
  const itemTotal = baseAmount + addonsTotal;

  const it = {
    label: name,
    kind: currentComputed.kind,
    input: { heightCm: currentComputed.Hcm, depthCm: currentComputed.Dcm, widthCm: currentComputed.Wcm, qtySet: currentComputed.qtySet },
    matched: {
      code: currentMatch.code,
      name: currentMatch.name,
      heightMm: currentMatch.heightMm,
      depthMm: currentMatch.depthMm,
      widthMm: currentMatch.widthMm,
      unitPrice: currentMatch.price
    },
    countPerSet: currentComputed.countPerSet,
    countTotal: currentComputed.countTotal,
    baseAmount,

    addons: {
      drawer: dr.code ? dr : null,
      boards: bLines,
      hardwares: hLines,
      boardsTotal,
      hwTotal,
      addonsTotal
    },

    amount: itemTotal
  };

  cartItems.push(it);
  renderCart();
  calcTotal();
};

/* ===== 渲染購物車 ===== */
function renderCart(){
  if(!cartItems.length){
    quoteList.innerHTML = `<p class="text-xs text-slate-400">尚未加入任何項目。</p>`;
    return;
  }

  quoteList.innerHTML = cartItems.map((it,i)=>{
    const dr = it.addons?.drawer;
    const b = it.addons?.boards || [];
    const h = it.addons?.hardwares || [];

    const drawerText = dr
      ? `<p class="text-[11px] text-slate-600">抽屜：${dr.code}｜${dr.name}｜$${dr.unitPrice}/${dr.unit} × ${dr.qty} = ${money(dr.amount)}</p>`
      : `<p class="text-[11px] text-slate-400">抽屜：不需要</p>`;

    const boardsText = b.length
      ? b.map(x=>`<p class="text-[11px] text-slate-600">板材：${x.code}｜${x.name}｜${x.lengthCm}×${x.widthCm}cm×${x.pieces}片＝${x.areaCm2.toFixed(0)}cm² → ${x.cai}才｜${money(x.amount)}</p>`).join("")
      : `<p class="text-[11px] text-slate-400">板材：未填</p>`;

    const hwText = h.length
      ? h.map(x=>`<p class="text-[11px] text-slate-600">五金/加工：${x.code}｜${x.name}｜$${x.unitPrice}/${x.unit} × ${x.qty} = ${money(x.amount)}</p>`).join("")
      : `<p class="text-[11px] text-slate-400">五金/加工：未填</p>`;

    return `
      <div class="border rounded-xl px-3 py-2">
        <div class="flex justify-between items-start">
          <div class="text-xs">
            <p class="font-semibold text-slate-800">${it.label}（${it.kind}）</p>
            <p class="text-[11px] text-slate-500">
              輸入：高 ${it.input.heightCm} / 深 ${it.input.depthCm} / 寬 ${it.input.widthCm} cm｜組數 ${it.input.qtySet}
            </p>
            <p class="text-[11px] text-emerald-700">
              櫃體匹配：[${it.matched.code}] 高 ${(it.matched.heightMm/10).toFixed(0)} / 深 ${(it.matched.depthMm/10).toFixed(0)} / 寬 ${(it.matched.widthMm/10).toFixed(0)}
              ｜$${it.matched.unitPrice.toLocaleString()} / 櫃
            </p>
            <p class="text-[11px] text-slate-500">
              櫃體：每組${it.countPerSet} × 組數${it.input.qtySet} = ${it.countTotal} 櫃｜櫃體小計 ${money(it.baseAmount)}
            </p>

            <div class="mt-2 border-t pt-2">
              <p class="text-[11px] font-semibold text-slate-700">配件</p>
              ${drawerText}
              ${boardsText}
              ${hwText}
              <p class="text-[11px] text-slate-700 font-semibold mt-1">本項合計：${money(it.amount)}</p>
            </div>
          </div>
          <button data-i="${i}" class="text-red-500 text-[11px] removeBtn">刪除</button>
        </div>
      </div>
    `;
  }).join("");

  document.querySelectorAll(".removeBtn").forEach(btn=>{
    btn.onclick=()=>{
      cartItems.splice(btn.dataset.i,1);
      renderCart();
      calcTotal();
    };
  });
}

/* ===== 總價 ===== */
function calcTotal(){
  if(!cartItems.length){
    subtotalDisplay.textContent="—";
    totalDisplay.textContent="—";
    footerTotal.textContent="—";
    ufAmountDisplay.textContent="+ $0";
    return { subtotal:0, ufFee:0, total:0 };
  }

  const subtotal = cartItems.reduce((s,x)=>s + (x.amount||0), 0);
  subtotalDisplay.textContent = money(subtotal);

  let ufFee = 0;
  if(subtotal < 50000) ufFee = 6000;
  ufAmountDisplay.textContent = `+ ${money(ufFee)}`;

  const total = subtotal + ufFee;
  totalDisplay.textContent = money(total);
  footerTotal.textContent = money(total);

  return { subtotal, ufFee, total };
}

/* ===== payload ===== */
function buildPayload(){
  const { subtotal, ufFee, total } = calcTotal();

  const itemsText = cartItems.map((it,i)=>{
    const dr = it.addons?.drawer;
    const b = it.addons?.boards || [];
    const h = it.addons?.hardwares || [];

    const drText = dr
      ? `   抽屜：${dr.code}｜${dr.name}｜$${dr.unitPrice}/${dr.unit} × ${dr.qty} = ${money(dr.amount)}\n`
      : `   抽屜：不需要\n`;

    const bText = b.length
      ? b.map(x=>`   板材：${x.code}｜${x.name}｜${x.lengthCm}×${x.widthCm}cm×${x.pieces}片＝${x.areaCm2.toFixed(0)}cm² → ${x.cai}才｜${money(x.amount)}`).join("\n") + "\n"
      : `   板材：未填\n`;

    const hText = h.length
      ? h.map(x=>`   五金/加工：${x.code}｜${x.name}｜$${x.unitPrice}/${x.unit} × ${x.qty} = ${money(x.amount)}`).join("\n") + "\n"
      : `   五金/加工：未填\n`;

    return (
      `${i+1}. ${it.label}（${it.kind}）\n` +
      `   輸入：高${it.input.heightCm} 深${it.input.depthCm} 寬${it.input.widthCm}cm｜組數${it.input.qtySet}\n` +
      `   櫃體匹配：${it.matched.code}｜高${(it.matched.heightMm/10).toFixed(0)} 深${(it.matched.depthMm/10).toFixed(0)} 寬${(it.matched.widthMm/10).toFixed(0)}｜$${it.matched.unitPrice}/櫃\n` +
      `   櫃體櫃數：每組${it.countPerSet} × 組數${it.input.qtySet} = ${it.countTotal}｜櫃體小計：${money(it.baseAmount)}\n` +
      `   配件：\n` +
      drText + bText + hText +
      `   本項合計：${money(it.amount)}`
    );
  }).join("\n\n");

  return {
    userId,
    customerName: document.getElementById("customerName").value.trim(),
    customerPhone: document.getElementById("customerPhone").value.trim(),
    subtotal,
    ufFee,
    total,
    itemsText,
    itemsRaw: JSON.stringify(cartItems)
  };
}

/* ===== LIFF ===== */
async function initLiff(){
  try{
    await liff.init({ liffId:"2008590887-zkqDbWqb" });

    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: window.location.href });
      return;
    }

    try{
      const profile = await liff.getProfile();
      userId = profile.userId;
    }catch(e){
      const decoded = liff.getDecodedIDToken?.();
      userId = decoded?.sub || null;
    }

    if(!userId){
      const decoded = liff.getDecodedIDToken?.();
      userId = decoded?.sub || null;
    }
  }catch(err){
    console.error("LIFF init failed:", err);
  }
}

/* ===== send ===== */
async function sendToMake(){
  const name = document.getElementById("customerName").value.trim();
  const phone = document.getElementById("customerPhone").value.trim();
  if(!name || !phone){
    alert("請完整填寫：姓名 + 電話");
    return;
  }
  if(!cartItems.length){
    alert("請先加入至少 1 個項目");
    return;
  }
  if(!userId){
    alert("無法取得 userId，請從 LINE App 開啟頁面，或在外部瀏覽器完成 LINE 登入。");
    return;
  }

  const payload = buildPayload();

  await fetch("https://hook.us2.make.com/ajl0cxe88ppt16rbtvj8rgepu8tredg9",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });

  alert("報價已送出！");
  if(liff.isInClient()) liff.closeWindow();
}

/* ===== INIT ===== */
document.addEventListener("DOMContentLoaded", async ()=>{
  initScale();
  const btn = document.getElementById("fontToggleBtn");
  if(btn) btn.onclick = toggleScale;

  // 預設先各新增一列板材/五金（可刪）
  addBoardLine();
  addHwLine();

  try{
    await initLiff();

    // 逐一載入，成功/失敗都記錄，彈窗提供精準錯誤
    const results = [];

    // 1) 櫃體
    try{
      await loadCabinetSheet();
      results.push({ ok:true, name:"cabinets（櫃體）", count:cabinetRows.length, url:CABINETS_CSV });
    }catch(e){
      results.push({ ok:false, name:"cabinets（櫃體）", err:e, url:CABINETS_CSV });
    }

    // 2) 抽屜
    try{
      drawerRows = await loadSimpleTab(DRAWERS_CSV);
      results.push({ ok:true, name:"drawers（抽屜）", count:drawerRows.length, url:DRAWERS_CSV });
    }catch(e){
      results.push({ ok:false, name:"drawers（抽屜）", err:e, url:DRAWERS_CSV });
    }

    // 3) 板材
    try{
      boardRows = await loadSimpleTab(BOARDS_CSV);
      results.push({ ok:true, name:"boards（板材）", count:boardRows.length, url:BOARDS_CSV });
    }catch(e){
      results.push({ ok:false, name:"boards（板材）", err:e, url:BOARDS_CSV });
    }

    // 4) 五金/加工
    try{
      hardwareRows = await loadSimpleTab(HARDWARES_CSV);
      results.push({ ok:true, name:"hardwares（五金/加工）", count:hardwareRows.length, url:HARDWARES_CSV });
    }catch(e){
      results.push({ ok:false, name:"hardwares（五金/加工）", err:e, url:HARDWARES_CSV });
    }

    const okAll = results.every(x=>x.ok);
    const okText = results.filter(x=>x.ok).map(x=>`${x.name}：${x.count}筆`).join("｜") || "—";
    const failText = results.filter(x=>!x.ok).map(x=>x.name).join("｜") || "";

    document.getElementById("loadStatus").textContent =
      okAll ? `價目表載入完成（${okText}）` : `部分價目表載入失敗（成功：${okText}）`;
    document.getElementById("loadStatus2").textContent =
      okAll ? "—" : `失敗：${failText}`;

    // 若有失敗：精準彈窗（比「可能需要 gid」更清楚）
    if(!okAll){
      const lines = [];
      lines.push("【價目表載入失敗】");
      lines.push("你的網頁需要從 Google 讀取 CSV；若檔案未公開或未「發佈到網頁」，LIFF 會抓不到資料。");
      lines.push("");
      results.filter(x=>!x.ok).forEach(x=>{
        const st = x.err?.status ? `HTTP ${x.err.status}` : "（無狀態碼）";
        lines.push(`- ${x.name}：${st}`);
        lines.push(`  連結：${x.url}`);
        const msg = (x.err?.message || "").split("\n")[0];
        if(msg) lines.push(`  錯誤：${msg}`);
      });
      lines.push("");
      lines.push("請到 Google Sheet 執行：");
      lines.push("1) 共用 → 一般存取：改成「知道連結的任何人：檢視者」");
      lines.push("2) 檔案 → 共用 → 發佈到網頁（Publish to web）→ 重新發佈");
      lines.push("3) 回到 LIFF 頁面重新整理（建議無痕/清快取）");

      alert(lines.join("\n"));
    }

    // render 配件 rows
    renderBoardLines();
    renderHwLines();

    // 初始化依深度刷新抽屜選項
    refreshDrawerOptions();

    // 櫃體即時計算
    updateMatchAndPreview();

    cabinetKindEl.onchange = updateMatchAndPreview;
    heightEl.oninput = updateMatchAndPreview;
    depthEl.oninput  = updateMatchAndPreview;
    widthEl.oninput  = updateMatchAndPreview;
    qtySetEl.oninput = updateMatchAndPreview;

    drawerCodeEl.onchange = updateAddonPreview;
    drawerQtyEl.oninput = updateAddonPreview;

    document.getElementById("addBoardRowBtn").onclick = addBoardLine;
    document.getElementById("addHwRowBtn").onclick = addHwLine;

    document.getElementById("sendBtn").onclick = sendToMake;

  }catch(err){
    // 最外層保險（真的爆炸才會來這裡）
    console.error(err);
    alert("系統初始化失敗，請稍後重試或檢查網路連線。");
  }
});
</script>

</body>
</html>
