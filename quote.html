<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>蝦拼組 系統櫃報價</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{box-sizing:border-box;}html,body{height:100%;-webkit-overflow-scrolling:touch;}*{-webkit-tap-highlight-color:transparent;}
    .wood-bg{background-image:linear-gradient(135deg,#D6B28F 0%,#F5DEB3 45%,#C59F7B 100%);}
    .elevated{box-shadow:0 18px 40px rgba(15,23,42,0.25);}
  </style>
</head>

<body class="min-h-screen bg-[#0f172a]">
<div class="max-w-md mx-auto min-h-screen flex flex-col bg-slate-100">

  <!-- HEADER -->
  <header class="relative overflow-hidden">
    <div class="wood-bg h-20 w-full"></div>
    <div class="absolute inset-x-0 bottom-0 h-20 bg-gradient-to-t from-[#022c22] via-[#064e3b]/95 to-transparent"></div>
    <div class="absolute inset-0 flex flex-col justify-end px-4 pb-4">
      <p class="text-xs text-amber-100/90 tracking-[0.25em] mb-1">SYSTEM CABINET QUOTE</p>
      <h1 class="text-2xl font-semibold text-white">蝦拼組 <span class="text-emerald-200 text-lg">系統櫃報價</span></h1>
      <p class="text-[11px] text-emerald-100/80 mt-1">輸入總寬/高/深（cm）｜自動匹配 高/深/寬30 櫃體單價｜不足一櫃補一櫃</p>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 overflow-y-auto px-4 pb-28 pt-4 space-y-4">

    <!-- 客戶資訊 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">1</span>
        客戶資訊（必填）
      </h2>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">客戶姓名</label>
          <input id="customerName" required type="text"
            class="w-full border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-emerald-300"
            placeholder="例如：王設計" />
        </div>

        <div>
          <label class="block text-xs text-slate-500 mb-1">聯絡電話</label>
          <input id="customerPhone" required type="tel"
            class="w-full border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-emerald-300"
            placeholder="必填" />
        </div>
      </div>
    </section>

    <!-- 櫃體尺寸輸入 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">2</span>
        櫃體尺寸輸入（自動帶入單價）
      </h2>

      <p id="loadStatus" class="text-[11px] text-slate-400">正在從 Google Sheet 載入櫃體價目表…</p>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">櫃體名稱（可選）</label>
          <input id="cabinetLabel" type="text"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：衣櫃 / 玄關櫃" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">固定規格</label>
          <p class="text-[11px] text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-lg px-2 py-[6px]">
            以「寬 30cm」櫃體單價計算（總寬 ÷ 30cm，不足一櫃補一櫃）
          </p>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-3 text-sm">
        <div>
          <label class="block text-xs text-slate-500 mb-1">總寬度（cm）</label>
          <input id="totalWidthCm" type="number" min="0" step="1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：340" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">高度（cm）</label>
          <input id="heightCm" type="number" min="0" step="1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：210" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">深度（cm）</label>
          <input id="depthCm" type="number" min="0" step="1"
            class="w-full border rounded-lg px-3 py-2 text-sm"
            placeholder="例如：53" />
        </div>
      </div>

      <div class="border rounded-xl px-3 py-2 bg-slate-50">
        <p class="text-xs text-slate-600 font-medium">自動帶入結果</p>
        <p id="matchHint" class="text-[11px] text-slate-500 mt-1">請輸入總寬/高/深（cm），系統會自動匹配「高/深/寬30」單價並換算櫃數。</p>
        <p id="linePreview" class="text-sm font-semibold text-slate-800 mt-1">—</p>
      </div>

      <button id="addItemBtn"
        class="w-full mt-2 bg-emerald-700 text-white text-sm font-semibold py-2 rounded-xl shadow-md active:scale-95">
        加入本次報價
      </button>
    </section>

    <!-- 報價清單 -->
    <section class="bg-white rounded-2xl elevated p-4 space-y-3 mb-2">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">3</span>
        報價項目清單（櫃體）
      </h2>

      <div id="quoteList" class="space-y-2 text-sm">
        <p class="text-xs text-slate-400">尚未加入任何項目。</p>
      </div>

      <div class="border-t pt-2 mt-2 text-sm">
        <div class="flex justify-between items-center">
          <span class="text-slate-600 font-medium">小計</span>
          <span id="subtotalDisplay" class="font-semibold text-slate-800">—</span>
        </div>

        <div class="flex items-center justify-between mt-2 text-xs">
          <span class="text-slate-600">未滿五萬運費工資補貼</span>
          <span id="ufAmountDisplay" class="text-slate-700">+ $0</span>
        </div>

        <div class="flex justify-between items-center mt-2 border-t pt-2">
          <span class="text-slate-700 font-semibold">總價</span>
          <span id="totalDisplay" class="text-lg font-bold text-emerald-700">—</span>
        </div>
      </div>
    </section>

  </main>

  <!-- 底部 -->
  <footer class="fixed bottom-0 left-0 right-0 bg-[#022c22] border-t border-emerald-900/40">
    <div class="max-w-md mx-auto flex items-center justify-between px-4 py-3 gap-3">
      <div class="text-xs text-emerald-100">
        <p class="font-semibold">報價總額</p>
        <p id="footerTotal" class="text-lg font-bold text-emerald-300">—</p>
      </div>

      <button id="sendBtn"
        class="flex-1 bg-emerald-500 text-emerald-950 text-sm font-semibold py-2 rounded-xl shadow-lg active:scale-95">
        傳送報價
      </button>
    </div>
  </footer>

</div>

<script>
/* 櫃體價目表（CSV） */
const CABINETS_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=0&single=true&output=csv";

/* 固定以寬 30cm 的櫃體單價計算（總寬 ÷ 30） */
const BASE_CABINET_WIDTH_CM = 30;

/* 注意：你的資料表「高度/深度」是 300/600/2100/600 這種格式（mm），
   使用者輸入是 cm（例如 210 / 53），所以需要 cm → mm（×10）做匹配 */
const CM_TO_MM = 10;

let cabinetRows = [];   // {code,name,heightMm,depthMm,widthCm,price,type}
let quoteItems = [];
let userId = null;

/* CSV parser */
function parseCSV(text){
  const quotes=/^"|"$/g;
  return text.trim().split("\n").map(r =>
    r.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(v=>v.replace(quotes,"").trim())
  );
}

/* 載入櫃體價目表（直接用欄位：高度/深度/寬度/單價/類型） */
async function loadCabinetSheet(){
  const url = CABINETS_CSV + "&rand=" + Math.random();
  const res = await fetch(url);
  const text = await res.text();
  const rows = parseCSV(text);
  const header = rows[0];

  const idxCode  = header.indexOf("編碼");
  const idxName  = header.indexOf("名稱");
  const idxH     = header.indexOf("高度");
  const idxD     = header.indexOf("深度");
  const idxW     = header.indexOf("寬度");
  const idxPrice = header.indexOf("單價");
  const idxType  = header.indexOf("類型");

  const raw = rows.slice(1).map(r => {
    const code = (r[idxCode] || "").trim();
    const name = (r[idxName] || "").trim();

    // 高度/深度：mm（例如 2100/600）；寬度：cm（例如 30）
    const heightMm = parseInt((r[idxH] || "0").replace(/[^0-9]/g,""), 10) || 0;
    const depthMm  = parseInt((r[idxD] || "0").replace(/[^0-9]/g,""), 10) || 0;
    const widthCm  = parseInt((r[idxW] || "0").replace(/[^0-9]/g,""), 10) || 0;

    const price = parseInt((r[idxPrice] || "0").toString().replace(/[^0-9]/g,""), 10) || 0;
    const type  = (r[idxType] || "").trim();

    return { code, name, heightMm, depthMm, widthCm, price, type };
  })
  .filter(x => x.code && x.price > 0 && x.type === "櫃體" && x.heightMm > 0 && x.depthMm > 0 && x.widthCm > 0);

  cabinetRows = raw;

  loadStatus.textContent = `已載入 ${cabinetRows.length} 筆櫃體資料（寬${BASE_CABINET_WIDTH_CM}cm 規格將優先使用）`;
  updateMatchAndPreview();
}

/* 匹配規則：
   - 寬度：優先 width=30cm；若沒有，改用最接近 30cm（會提示）
   - 高度：優先 exact（mm）；沒有就找最接近高度（mm）
   - 深度：向上取「>=輸入深度(mm)」的最小深度；若都小於則用最大深度
   - 同一規格若同時存在「開門櫃」與「空櫃」，優先使用「開門櫃」
*/
function findBestCabinetRate(inputHeightMm, inputDepthMm, requiredWidthCm){
  const candidates = cabinetRows.slice();
  if(!candidates.length) return { best:null, warn:"櫃體價目表無有效資料。" };

  // 1) width pool
  let widthPool = candidates.filter(x => x.widthCm === requiredWidthCm);
  let widthWarn = "";
  if(!widthPool.length){
    const sortedByW = candidates.slice().sort((a,b)=>Math.abs(a.widthCm-requiredWidthCm)-Math.abs(b.widthCm-requiredWidthCm));
    const bestW = sortedByW[0].widthCm;
    widthPool = candidates.filter(x => x.widthCm === bestW);
    widthWarn = `找不到寬${requiredWidthCm}，已改用寬${bestW}作為備援。`;
  }

  // 2) height pool (exact > closest)
  let heightPool = widthPool.filter(x => x.heightMm === inputHeightMm);
  if(!heightPool.length){
    const sortedByH = widthPool.slice().sort((a,b)=>Math.abs(a.heightMm-inputHeightMm)-Math.abs(b.heightMm-inputHeightMm));
    const pickH = sortedByH[0].heightMm;
    heightPool = widthPool.filter(x => x.heightMm === pickH);
  }

  // 3) depth: smallest >= inputDepthMm else max
  const depthSorted = heightPool.slice().sort((a,b)=>a.depthMm-b.depthMm);
  let best = depthSorted.find(x => x.depthMm >= inputDepthMm);
  if(!best) best = depthSorted[depthSorted.length-1] || null;

  if(!best) return { best:null, warn:"無法匹配到櫃體單價（請確認表內高度/深度/寬度）。" };

  // 4) prefer 開門櫃 if same H/D/W exists
  const sameSpec = heightPool.filter(x => x.heightMm === best.heightMm && x.depthMm === best.depthMm && x.widthCm === best.widthCm);
  const prefer = sameSpec.find(x => x.name.includes("開門櫃")) || best;

  return { best: prefer, warn: widthWarn };
}

/* 櫃數計算：商 +（有餘數就 +1），全程整數運算（cm） */
function calcCabinetCount(totalWidthCm){
  const total = parseInt(totalWidthCm || "0", 10);
  const base  = parseInt(BASE_CABINET_WIDTH_CM || "0", 10);
  if(!(total > 0 && base > 0)) return 0;

  const quotient  = Math.floor(total / base);
  const remainder = total % base;

  return quotient + (remainder > 0 ? 1 : 0);
}

/* UI elements */
const totalWidthEl = document.getElementById("totalWidthCm");
const heightEl     = document.getElementById("heightCm");
const depthEl      = document.getElementById("depthCm");

const matchHint   = document.getElementById("matchHint");
const linePreview = document.getElementById("linePreview");

const quoteList       = document.getElementById("quoteList");
const subtotalDisplay = document.getElementById("subtotalDisplay");
const ufAmountDisplay = document.getElementById("ufAmountDisplay");
const totalDisplay    = document.getElementById("totalDisplay");
const footerTotal     = document.getElementById("footerTotal");

let currentMatch = null;
let currentCount = 0;

function updateMatchAndPreview(){
  const totalWcm = parseInt(totalWidthEl.value || "0", 10);
  const Hcm = parseInt(heightEl.value || "0", 10);
  const Dcm = parseInt(depthEl.value  || "0", 10);

  currentMatch = null;
  currentCount = 0;

  if(!(totalWcm > 0 && Hcm > 0 && Dcm > 0)){
    matchHint.textContent = "請輸入總寬/高/深（cm），系統會自動匹配「高/深/寬30」單價並換算櫃數。";
    linePreview.textContent = "—";
    return;
  }

  const count = calcCabinetCount(totalWcm);

  // cm -> mm (×10) for matching height/depth
  const Hmm = Hcm * CM_TO_MM;
  const Dmm = Dcm * CM_TO_MM;

  const { best, warn } = findBestCabinetRate(Hmm, Dmm, BASE_CABINET_WIDTH_CM);

  if(!best){
    matchHint.textContent = warn || "找不到可匹配的櫃體單價。";
    linePreview.textContent = "—";
    return;
  }

  currentMatch = best;
  currentCount = count;

  const amount = Math.round(best.price * count);
  const effectiveWidth = count * BASE_CABINET_WIDTH_CM;

  const warnText = warn ? `（注意：${warn}）` : "";
  matchHint.textContent =
    `已匹配：高 ${(best.heightMm/10).toFixed(0)} / 深 ${(best.depthMm/10).toFixed(0)} / 寬 ${best.widthCm} ${warnText}（來源：[${best.code}] ${best.name}）`;

  linePreview.textContent =
    `總寬 ${totalWcm}cm → 櫃數 ${count}（寬${BASE_CABINET_WIDTH_CM} × ${count} = ${effectiveWidth}cm）｜單價 $${best.price.toLocaleString()} × ${count} = $${amount.toLocaleString()}`;
}

/* 新增櫃體項目 */
document.getElementById("addItemBtn").onclick = () => {
  const label = document.getElementById("cabinetLabel").value.trim() || "櫃體";
  const totalWcm = parseInt(totalWidthEl.value || "0", 10);
  const Hcm = parseInt(heightEl.value || "0", 10);
  const Dcm = parseInt(depthEl.value  || "0", 10);

  if(!(totalWcm > 0 && Hcm > 0 && Dcm > 0)){
    alert("請完整輸入：總寬度 / 高度 / 深度（cm）");
    return;
  }
  if(!currentMatch || !(currentCount > 0)){
    alert("尚未匹配到單價或櫃數，請確認價目表是否正常載入。");
    return;
  }

  const amount = Math.round(currentMatch.price * currentCount);

  quoteItems.push({
    type: "cabinet",
    label,
    input: { totalWidthCm: totalWcm, heightCm: Hcm, depthCm: Dcm },
    baseWidthCm: BASE_CABINET_WIDTH_CM,
    count: currentCount,
    matched: {
      code: currentMatch.code,
      name: currentMatch.name,
      heightMm: currentMatch.heightMm,
      depthMm: currentMatch.depthMm,
      widthCm: currentMatch.widthCm,
      unitPrice: currentMatch.price
    },
    amount
  });

  renderList();
  calcTotal();
};

/* 渲染清單 */
function renderList(){
  if(!quoteItems.length){
    quoteList.innerHTML = `<p class="text-xs text-slate-400">尚未加入任何項目。</p>`;
    subtotalDisplay.textContent="—";
    totalDisplay.textContent="—";
    footerTotal.textContent="—";
    ufAmountDisplay.textContent="+ $0";
    return;
  }

  quoteList.innerHTML = quoteItems.map((it,i)=>`
    <div class="border rounded-xl px-3 py-2">
      <div class="flex justify-between items-start">
        <div class="text-xs">
          <p class="font-semibold text-slate-800">${it.label}</p>
          <p class="text-[11px] text-slate-500">
            輸入：總寬 ${it.input.totalWidthCm} / 高 ${it.input.heightCm} / 深 ${it.input.depthCm}（cm）
          </p>
          <p class="text-[11px] text-emerald-700">
            匹配單價：高 ${(it.matched.heightMm/10).toFixed(0)} / 深 ${(it.matched.depthMm/10).toFixed(0)} / 寬 ${it.matched.widthCm}
            ｜$${it.matched.unitPrice.toLocaleString()} / 櫃（${it.matched.code}）
          </p>
          <p class="text-[11px] text-slate-500">
            櫃數：${it.count}（寬${it.baseWidthCm} × ${it.count} = ${it.baseWidthCm*it.count}cm）
            ｜小計：$${it.amount.toLocaleString()}
          </p>
        </div>
        <button data-i="${i}" class="text-red-500 text-[11px] removeBtn">刪除</button>
      </div>
    </div>
  `).join("");

  document.querySelectorAll(".removeBtn").forEach(btn=>{
    btn.onclick=()=>{
      quoteItems.splice(btn.dataset.i,1);
      renderList();
      calcTotal();
    };
  });
}

/* 計算總價 = subtotal + UF(自動) */
function calcTotal(){
  const subtotal = quoteItems.reduce((s,x)=>s + (x.amount||0), 0);
  subtotalDisplay.textContent = `$${subtotal.toLocaleString()}`;

  let ufFee = 0;
  if(subtotal < 50000) ufFee = 6000;
  ufAmountDisplay.textContent = `+ $${ufFee.toLocaleString()}`;

  const total = subtotal + ufFee;
  totalDisplay.textContent = `$${total.toLocaleString()}`;
  footerTotal.textContent = `$${total.toLocaleString()}`;

  return { subtotal, ufFee, total };
}

/* 建立送給 Make 的 payload */
function buildPayload(){
  const {subtotal, ufFee, total} = calcTotal();

  const itemsText = quoteItems.map((it,i)=>(
    `${i+1}. ${it.label}\n` +
    `   輸入：總寬${it.input.totalWidthCm} 高${it.input.heightCm} 深${it.input.depthCm}cm\n` +
    `   匹配：高${(it.matched.heightMm/10).toFixed(0)} 深${(it.matched.depthMm/10).toFixed(0)} 寬${it.matched.widthCm}｜$${it.matched.unitPrice}/櫃（${it.matched.code}）\n` +
    `   櫃數：${it.count}（寬${it.baseWidthCm}×${it.count}=${it.baseWidthCm*it.count}cm）｜小計：$${it.amount.toLocaleString()}`
  )).join("\n\n");

  return {
    userId,
    customerName: document.getElementById("customerName").value.trim(),
    customerPhone: document.getElementById("customerPhone").value.trim(),
    subtotal,
    ufFee,
    total,
    itemsText,
    itemsRaw: JSON.stringify(quoteItems)
  };
}

/* ♻️ LIFF 初始化 & 取得 userId（強化版） */
async function initLiff(){
  try{
    await liff.init({ liffId:"2008590887-zkqDbWqb" });

    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: window.location.href });
      return;
    }

    try{
      const profile = await liff.getProfile();
      userId = profile.userId;
    }catch(e){
      const decoded = liff.getDecodedIDToken?.();
      userId = decoded?.sub || null;
    }

    if(!userId){
      const decoded = liff.getDecodedIDToken?.();
      userId = decoded?.sub || null;
    }

    if(!userId){
      console.warn("LIFF 已登入，但 userId 仍取得失敗。");
    }
  }catch(err){
    console.error("LIFF init failed:", err);
    // userId = "TEST_USER";
  }
}

/* ★ 送到 Make */
async function sendToMake(){
  const name = document.getElementById("customerName").value.trim();
  const phone = document.getElementById("customerPhone").value.trim();
  if(!name || !phone){
    alert("請完整填寫：姓名 + 電話");
    return;
  }
  if(!quoteItems.length){
    alert("請先加入至少 1 個櫃體項目");
    return;
  }
  if(!userId){
    alert("無法取得 userId，請從 LINE App 開啟頁面，或在外部瀏覽器完成 LINE 登入。");
    return;
  }

  const payload = buildPayload();

  await fetch("https://hook.us2.make.com/ajl0cxe88ppt16rbtvj8rgepu8tredg9",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });

  alert("報價已送出！");
  if(liff.isInClient()) liff.closeWindow();
}

/* INIT */
document.addEventListener("DOMContentLoaded", async ()=>{
  await initLiff();
  await loadCabinetSheet();

  totalWidthEl.oninput = updateMatchAndPreview;
  heightEl.oninput     = updateMatchAndPreview;
  depthEl.oninput      = updateMatchAndPreview;

  document.getElementById("sendBtn").onclick = sendToMake;

  // 測試用（可打開）
  // totalWidthEl.value = 340;
  // heightEl.value = 210;
  // depthEl.value  = 53;
  // updateMatchAndPreview();
});
</script>

</body>
</html>
