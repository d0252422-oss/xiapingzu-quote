<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>拚拼組 系統櫃報價</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body{box-sizing:border-box;}
    html,body{height:100%;-webkit-overflow-scrolling:touch;}
    /* 回復原本的深色背景與漸層 */
    .wood-bg{background-image:linear-gradient(135deg,#D6B28F 0%,#F5DEB3 45%,#C59F7B 100%);}
    :root{ --scale: 1.25; }
    html{ font-size: calc(16px * var(--scale)); }
    
    /* 確保輸入框與按鈕在手機上易於點擊 */
    input, select, button{ font-size: 1.05rem !important; }
    .text-xs{ font-size: 0.95rem !important; }
    .text-[11px]{ font-size: 0.85rem !important; }
  </style>
</head>

<body class="min-h-screen bg-[#0f172a]">
<div class="max-w-md mx-auto min-h-screen flex flex-col bg-slate-100">

  <header class="relative overflow-hidden h-24">
    <div class="wood-bg h-full w-full"></div>
    <div class="absolute inset-0 bg-gradient-to-t from-[#022c22] to-transparent"></div>
    <div class="absolute inset-0 flex flex-col justify-end px-4 pb-3">
      <h1 class="text-2xl font-semibold text-white">拚拼組 <span class="text-emerald-200 text-lg">系統櫃報價</span></h1>
    </div>
  </header>

  <main class="flex-1 overflow-y-auto px-4 pb-48 pt-4 space-y-4">
    <section class="bg-white rounded-2xl shadow-lg p-4 space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <input id="customerName" type="text" class="border rounded-lg px-3 py-2" placeholder="客戶姓名" />
        <input id="customerPhone" type="tel" class="border rounded-lg px-3 py-2" placeholder="聯絡電話" />
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow-lg p-4 space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <input id="cabinetLabel" type="text" class="border rounded-lg px-3 py-2" placeholder="名稱 (如：衣櫃)" />
        <select id="cabinetKind" class="border rounded-lg px-3 py-2">
          <option value="開門櫃">開門櫃</option>
          <option value="空櫃">空櫃</option>
        </select>
      </div>
      <div class="grid grid-cols-3 gap-3">
        <input id="heightCm" type="number" class="border rounded-lg px-3 py-2" placeholder="高(cm)" />
        <input id="depthCm" type="number" class="border rounded-lg px-3 py-2" placeholder="深(cm)" />
        <input id="widthCm" type="number" class="border rounded-lg px-3 py-2" placeholder="寬(cm)" />
      </div>

      <div class="border-t pt-3 space-y-4">
        <div>
          <p class="text-xs font-bold text-slate-700 mb-1">抽屜 (依深度自動篩選)</p>
          <div class="grid grid-cols-3 gap-2">
            <select id="drawerCode" class="col-span-2 border rounded-lg px-2 py-2" disabled><option value="">請先輸入深度</option></select>
            <input id="drawerPerCab" type="number" value="1" class="border rounded-lg px-2 py-2 text-center" />
          </div>
        </div>

        <div>
          <p class="text-xs font-bold text-slate-700 mb-1">板材封板</p>
          <select id="boardCode" class="border rounded-lg w-full px-2 py-2 mb-2"><option value="">不需要</option></select>
          <div class="grid grid-cols-3 gap-2">
            <input id="boardLen" type="number" placeholder="長" class="border rounded-lg px-2 py-1" />
            <input id="boardWid" type="number" placeholder="寬" class="border rounded-lg px-2 py-1" />
            <input id="boardPcs" type="number" value="1" class="border rounded-lg px-2 py-1" />
          </div>
        </div>

        <div>
          <p class="text-xs font-bold text-slate-700 mb-1">五金</p>
          <div class="grid grid-cols-3 gap-2">
            <select id="hardwareCode" class="col-span-2 border rounded-lg px-2 py-2"><option value="">不需要</option></select>
            <input id="hardwareQty" type="number" value="1" class="border rounded-lg px-2 py-2 text-center" />
          </div>
        </div>
      </div>

      <div class="bg-emerald-50 p-2 rounded-lg border border-emerald-100 text-center">
        <p id="linePreview" class="text-xs font-bold text-emerald-800">請輸入尺寸</p>
      </div>
      <button id="addItemBtn" class="w-full bg-emerald-700 text-white font-bold py-3 rounded-xl">加入購物車</button>
    </section>

    <section class="bg-white rounded-2xl shadow-lg p-4">
      <h2 class="text-sm font-bold text-slate-700 mb-3 border-b pb-2">購物車內容</h2>
      <div id="quoteList" class="space-y-3"></div>
      <div class="mt-4 pt-2 border-t space-y-1 text-sm">
        <div class="flex justify-between"><span>小計</span><span id="subtotalDisplay">$0</span></div>
        <div class="flex justify-between text-xs text-slate-500"><span>補貼 (未滿五萬)</span><span id="ufAmountDisplay">$0</span></div>
        <div class="flex justify-between text-lg font-bold text-emerald-700 border-t pt-2"><span>總計</span><span id="totalDisplay">$0</span></div>
      </div>
    </section>
  </main>

  <footer class="fixed bottom-0 left-0 right-0 bg-[#022c22] p-4 flex items-center justify-between border-t border-emerald-900">
    <div class="text-emerald-100">
      <p class="text-xs">報價總結</p>
      <p id="footerTotal" class="text-lg font-bold text-emerald-300">$0</p>
    </div>
    <button id="sendBtn" class="bg-emerald-500 text-emerald-950 font-bold px-8 py-2 rounded-xl">傳送報價</button>
  </footer>
</div>

<script>
const CSV = {
  CAB: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=0&single=true&output=csv",
  DRA: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=1520827127&single=true&output=csv",
  BOA: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=71905260&single=true&output=csv",
  HAR: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=206474142&single=true&output=csv"
};

let db = { cab:[], dra:[], boa:[], har:[] };
let cartItems = [];
let userId = null;

// 解析 CSV：專門針對您的 Excel 格式優化
function parseCSV(text) {
  const lines = text.trim().split("\n");
  if (lines.length < 2) return [];
  const rows = lines.map(line => line.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(v => v.replace(/^"|"$/g, '').trim()));
  
  // 取得標頭並找出索引
  const head = rows[0];
  const idx = {
    code: head.findIndex(h => h.includes("編碼")),
    name: head.findIndex(h => h.includes("名稱")),
    price: head.findIndex(h => h.includes("單價")),
    h: head.findIndex(h => h.includes("高度")),
    d: head.findIndex(h => h.includes("深度")),
    w: head.findIndex(h => h.includes("寬度"))
  };

  return rows.slice(1).map(r => ({
    code: r[idx.code] || "",
    name: r[idx.name] || "名稱讀取失敗",
    price: parseInt(String(r[idx.price] || "0").replace(/[^\d]/g, "")) || 0,
    h: parseInt(r[idx.h]) || 0, d: parseInt(r[idx.d]) || 0, w: parseInt(r[idx.w]) || 0
  })).filter(x => x.code !== "");
}

async function fetchData() {
  const [c, d, b, h] = await Promise.all([
    fetch(CSV.CAB + "&t=" + Date.now()).then(r => r.text()),
    fetch(CSV.DRA + "&t=" + Date.now()).then(r => r.text()),
    fetch(CSV.BOA + "&t=" + Date.now()).then(r => r.text()),
    fetch(CSV.HAR + "&t=" + Date.now()).then(r => r.text())
  ]);
  db.cab = parseCSV(c);
  db.dra = parseCSV(d); // 抽屜資料
  db.boa = parseCSV(b);
  db.har = parseCSV(
