<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>拚拼組 系統櫃報價</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{box-sizing:border-box; font-family: sans-serif;}
    html,body{height:100%;-webkit-overflow-scrolling:touch; background-color: #0f172a;}
    :root{ --scale: 1.25; }
    html{ font-size: calc(16px * var(--scale)); }
    .wood-bg{background-image:linear-gradient(135deg,#D6B28F 0%,#F5DEB3 45%,#C59F7B 100%);}
    .elevated{box-shadow:0 10px 25px rgba(0,0,0,0.2);}
    input, select, button{ font-size: 1rem !important; padding: 0.6rem !important; }
  </style>
</head>

<body class="flex justify-center">
<div class="w-full max-w-md min-h-screen bg-slate-100 flex flex-col relative">

  <header class="wood-bg h-24 flex flex-col justify-end px-4 pb-3 relative">
    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
    <h1 class="text-white text-xl font-bold relative z-10">拚拼組 <span class="text-emerald-300">系統櫃報價</span></h1>
    <p class="text-white/80 text-xs relative z-10">Excel 自動連動版</p>
  </header>

  <main class="p-4 space-y-4 mb-32">
    <section class="bg-white rounded-xl p-4 elevated space-y-3">
      <div class="grid grid-cols-2 gap-2">
        <input id="customerName" type="text" placeholder="客戶姓名" class="border rounded-lg w-full">
        <input id="customerPhone" type="tel" placeholder="電話" class="border rounded-lg w-full">
      </div>
      <div class="grid grid-cols-3 gap-2">
        <input id="heightCm" type="number" placeholder="高(cm)" class="border rounded-lg w-full">
        <input id="depthCm" type="number" placeholder="深(cm)" class="border rounded-lg w-full">
        <input id="widthCm" type="number" placeholder="寬(cm)" class="border rounded-lg w-full">
      </div>
      <select id="cabinetKind" class="border rounded-lg w-full">
        <option value="開門櫃">開門櫃</option>
        <option value="空櫃">空櫃</option>
      </select>
    </section>

    <section class="bg-white rounded-xl p-4 elevated space-y-4">
      <p class="font-bold text-slate-700 border-b pb-2">配件選擇</p>
      
      <div>
        <label class="text-xs text-slate-500">抽屜 (自動篩選 A/B 系列)</label>
        <div class="flex gap-2 mt-1">
          <select id="drawerCode" class="border rounded-lg flex-1 bg-slate-50" disabled>
            <option value="">請先輸入深度</option>
          </select>
          <input id="drawerPerCab" type="number" value="1" class="border rounded-lg w-16 text-center" placeholder="數量">
        </div>
      </div>

      <div>
        <label class="text-xs text-slate-500">板材封板</label>
        <select id="boardCode" class="border rounded-lg w-full mt-1"><option value="">不需要</option></select>
        <div class="grid grid-cols-3 gap-2 mt-2">
          <input id="boardLen" type="number" placeholder="長" class="border rounded-lg text-sm">
          <input id="boardWid" type="number" placeholder="寬" class="border rounded-lg text-sm">
          <input id="boardPcs" type="number" value="1" class="border rounded-lg text-sm">
        </div>
      </div>
    </section>

    <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
      <p class="text-xs text-emerald-800">即時計算預覽：</p>
      <p id="linePreview" class="font-bold text-emerald-900">—</p>
    </div>

    <button id="addItemBtn" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">
      加入購物車
    </button>

    <div id="cartList" class="space-y-2"></div>
  </main>

  <footer class="fixed bottom-0 w-full max-w-md bg-slate-900 p-4 flex justify-between items-center border-t border-slate-700">
    <div class="text-white">
      <p class="text-xs text-slate-400">總計金額</p>
      <p id="totalDisplay" class="text-xl font-bold text-emerald-400">$0</p>
    </div>
    <button id="sendBtn" class="bg-emerald-500 text-slate-950 px-6 py-2 rounded-lg font-bold">傳送報價</button>
  </footer>
</div>

<script>
// CSV 來源
const CSV_URLS = {
  cab: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=0&single=true&output=csv",
  dra: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=1520827127&single=true&output=csv",
  boa: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=71905260&single=true&output=csv",
  har: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=206474142&single=true&output=csv"
};

let db = { cab:[], dra:[], boa:[], har:[] };
let cart = [];

// 解析 CSV 核心邏輯
function parseData(text) {
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',').map(h => h.trim());
  
  // 找出關鍵欄位索引
  const i = {
    code: headers.findIndex(h => h.includes("編碼")),
    name: headers.findIndex(h => h.includes("名稱")),
    price: headers.findIndex(h => h.includes("單價")),
    h: headers.findIndex(h => h.includes("高度")),
    d: headers.findIndex(h => h.includes("深度")),
    w: headers.findIndex(h => h.includes("寬度"))
  };

  return lines.slice(1).map(line => {
    const cols = line.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
    return {
      code: cols[i.code] || "",
      name: cols[i.name] || "未知",
      price: parseInt(cols[i.price]?.replace(/\D/g,'')) || 0,
      h: parseInt(cols[i.h]) || 0,
      d: parseInt(cols[i.d]) || 0,
      w: parseInt(cols[i.w]) || 0
    };
  }).filter(item => item.code !== "");
}

async function loadAllData() {
  try {
    const fetchText = (url) => fetch(url + "&t=" + Date.now()).then(r => r.text());
    const [c, d, b, h] = await Promise.all([fetchText(CSV_URLS.cab), fetchText(CSV_URLS.dra), fetchText(CSV_URLS.boa), fetchText(CSV_URLS.har)]);
    
    db.cab = parseData(c);
    db.dra = parseData(d);
    db.boa = parseData(b);
    db.har = parseData(h);
    
    // 初始化板材選單
    const boaEl = document.getElementById("boardCode");
    db.boa.forEach(item => {
      boaEl.innerHTML += `<option value="${item.code}">${item.code} | ${item.name}</option>`;
    });
    console.log("資料庫載入成功", db);
  } catch(e) { alert("資料載入失敗，請檢查網路"); }
}

function updateUI() {
  const depth = parseInt(document.getElementById("depthCm").value || 0);
  const draEl = document.getElementById("drawerCode");
  
  if (depth <= 0) {
    draEl.disabled = true;
    draEl.innerHTML = '<option value="">請先輸入深度</option>';
  } else {
    draEl.disabled = false;
    const isDeep = depth > 60;
    const targetCodes = isDeep ? ["B1","B2","B3"] : ["A1","A2","A3"];
    
    const currentVal = draEl.value;
    let html = '<option value="">不需要</option>';
    
    targetCodes.forEach(code => {
      const match = db.dra.find(x => x.code === code);
      if (match) {
        html += `<option value="${match.code}">${match.code} | ${match.name} | $${match.price}</option>`;
      } else {
        html += `<option value="${code}">${code} | (名稱匹配失敗)</option>`;
      }
    });
    draEl.innerHTML = html;
    draEl.value = currentVal;
  }
  
  // 計算預覽
  const result = calcCurrent();
  document.getElementById("linePreview").textContent = result ? `目前合計: $${result.total.toLocaleString()}` : "等待輸入尺寸...";
}

function calcCurrent() {
  const h = parseInt(document.getElementById("heightCm").value) * 10;
  const d = parseInt(document.getElementById("depthCm").value) * 10;
  const w = parseInt(document.getElementById("widthCm").value) * 10;
  if (!h || !d || !w) return null;

  // 1. 櫃體計算
  const kind = document.getElementById("cabinetKind").value;
  const pool = db.cab.filter(x => x.name.includes(kind));
  let match = pool.filter(x => x.h === h).sort((a,b)=>a.d-b.d).find(x => x.d >= d);
  if(!match) match = pool.sort((a,b) => Math.abs(a.h-h) - Math.abs(b.h-h))[0];
  
  const cabCount = Math.ceil(w / (match.w || 100)) * (parseInt(document.getElementById("qtySet").value) || 1);
  const baseTotal = match.price * cabCount;

  // 2. 抽屜計算
  let accTotal = 0;
  let accList = [];
  const dCode = document.getElementById("drawerCode").value;
  if (dCode) {
    const dRow = db.dra.find(x => x.code === dCode);
    if (dRow) {
      const q = cabCount * (parseInt(document.getElementById("drawerPerCab").value) || 1);
      const amt = dRow.price * q;
      accTotal += amt;
      accList.push({ name: dRow.name, qty: q, price: dRow.price, amt: amt });
    }
  }

  // 3. 板材計算
  const bCode = document.getElementById("boardCode").value;
  if (bCode) {
    const bRow = db.boa.find(x => x.code === bCode);
    const bl = parseInt(document.getElementById("boardLen").value);
    const bw = parseInt(document.getElementById("boardWid").value);
    if (bRow && bl && bw) {
      const q = Math.ceil((bl * bw) / 900) * (parseInt(document.getElementById("boardPcs").value) || 1);
      const amt = bRow.price * q;
      accTotal += amt;
      accList.push({ name: bRow.name, qty: q, price: bRow.price, amt: amt });
    }
  }

  return { 
    name: document.getElementById("customerName").value || "櫃體",
    desc: `${h/10}x${d/10}x${w/10}cm (${kind})`,
    cabCount, 
    baseTotal, 
    accList, 
    total: baseTotal + accTotal 
  };
}

document.getElementById("addItemBtn").onclick = () => {
  const item = calcCurrent();
  if(!item) return alert("請輸入正確尺寸");
  cart.push(item);
  renderCart();
};

function renderCart() {
  const listEl = document.getElementById("cartList");
  listEl.innerHTML = cart.map((item, idx) => `
    <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-emerald-500 relative">
      <button onclick="cart.splice(${idx},1);renderCart();" class="absolute right-2 top-2 text-red-400">✕</button>
      <p class="font-bold text-sm">${item.name} - ${item.desc}</p>
      <p class="text-xs text-slate-500">櫃數: ${item.cabCount} | 櫃體小計: $${item.baseTotal.toLocaleString()}</p>
      ${item.accList.map(a => `<p class="text-xs text-emerald-600">+ ${a.name} x${a.qty} = $${a.amt.toLocaleString()}</p>`).join('')}
      <p class="text-right font-bold text-slate-800 border-t mt-1">$${item.total.toLocaleString()}</p>
    </div>
  `).join('');

  const subtotal = cart.reduce((sum, i) => sum + i.total, 0);
  const extra = (subtotal > 0 && subtotal < 50000) ? 6000 : 0;
  document.getElementById("totalDisplay").textContent = `$${(subtotal + extra).toLocaleString()}`;
}

document.getElementById("sendBtn").onclick = async () => {
  if(cart.length === 0) return alert("購物車是空的");
  const payload = {
    customer: document.getElementById("customerName").value,
    phone: document.getElementById("customerPhone").value,
    items: cart,
    finalTotal: document.getElementById("totalDisplay").textContent
  };
  
  await fetch("https://hook.us2.make.com/ajl0cxe88ppt16rbtvj8rgepu8tredg9", {
    method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload)
  });
  alert("報價單已成功送出！");
  liff.closeWindow();
};

// 啟動
window.onload = async () => {
  await liff.init({ liffId: "2008590887-zkqDbWqb" });
  if(!liff.isLoggedIn()) liff.login();
  await loadAllData();
  
  // 綁定監聽
  ["heightCm", "depthCm", "widthCm", "qtySet", "cabinetKind", "drawerCode", "drawerPerCab", "boardCode", "boardLen", "boardWid", "boardPcs"].forEach(id => {
    document.getElementById(id).oninput = updateUI;
  });
};
</script>
</body>
</html>
