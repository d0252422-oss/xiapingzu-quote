<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è¦æ‹¼çµ„ ç³»çµ±æ«ƒå ±åƒ¹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { box-sizing: border-box; }
    html, body { height: 100%; -webkit-overflow-scrolling: touch; }
    * { -webkit-tap-highlight-color: transparent; }

    .wood-bg {
      background-image: linear-gradient(135deg, #D6B28F 0%, #F5DEB3 45%, #C59F7B 100%);
    }
    .elevated {
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.25);
    }
  </style>
</head>

<body class="min-h-screen bg-[#0f172a]">
  <div class="max-w-md mx-auto min-h-screen flex flex-col bg-slate-100">

    <!-- HEADER -->
    <header class="relative overflow-hidden">
      <div class="wood-bg h-20 w-full"></div>
      <div class="absolute inset-x-0 bottom-0 h-20 bg-gradient-to-t from-[#022c22] via-[#064e3b]/95 to-transparent"></div>
      <div class="absolute inset-0 flex flex-col justify-end px-4 pb-4">
        <p class="text-xs text-amber-100/90 font-light tracking-[0.25em] mb-1">SYSTEM CABINET QUOTE</p>
        <h1 class="text-2xl font-semibold text-white tracking-wide">
          è¦æ‹¼çµ„ <span class="text-emerald-200 text-lg align-middle">ç³»çµ±æ«ƒå ±åƒ¹</span>
        </h1>
        <p class="text-[11px] text-emerald-100/80 mt-1">
          æ·±ç¶ å·¥ç¨‹é¢¨ï½œä»¥ Google Sheet åƒ¹ç›®è¡¨é©…å‹•
        </p>
      </div>
    </header>

    <!-- MAIN -->
    <main class="flex-1 overflow-y-auto px-4 pb-28 pt-4 space-y-4">

      <!-- å®¢æˆ¶è³‡è¨Š -->
      <section class="bg-white rounded-2xl elevated p-4 space-y-3">
        <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
          <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">1</span>
          å®¢æˆ¶è³‡è¨Šï¼ˆå¯ä¸å¡«ï¼‰
        </h2>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <label class="block text-xs text-slate-500 mb-1">å®¢æˆ¶å§“å</label>
            <input id="customerName" type="text"
              class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-emerald-300"
              placeholder="ä¾‹å¦‚ï¼šç‹è¨­è¨ˆ" />
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">è¯çµ¡é›»è©±</label>
            <input id="customerPhone" type="tel"
              class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-emerald-300"
              placeholder="å¯ä¸å¡«" />
          </div>
        </div>
      </section>

      <!-- æ–°å¢å ±åƒ¹é …ç›® -->
      <section class="bg-white rounded-2xl elevated p-4 space-y-3">
        <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
          <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">2</span>
          æ–°å¢å ±åƒ¹é …ç›®
        </h2>

        <p id="loadStatus" class="text-[11px] text-slate-400 mb-1">
          æ­£åœ¨å¾ Google Sheet è¼‰å…¥åƒ¹ç›®è¡¨â€¦
        </p>

        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <label class="block text-xs text-slate-500 mb-1">å•†å“ç¾¤çµ„</label>
            <select id="groupSelect"
              class="w-full border rounded-lg px-3 py-2 text-sm">
              <option value="ALL">å…¨éƒ¨</option>
              <option value="æ«ƒé«”">æ«ƒé«”</option>
              <option value="æŠ½å±œ">æŠ½å±œ</option>
              <option value="æ¿æ/å°æ¿">æ¿æï¼å°æ¿</option>
              <option value="äº”é‡‘/åŠ å·¥">äº”é‡‘ï¼åŠ å·¥ï¼é›»æ–™</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>

          <div>
            <label class="block text-xs text-slate-500 mb-1">å–®ä½æç¤º</label>
            <p id="unitHint" class="text-[11px] text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-lg px-2 py-[6px]">
              å…ˆé¸æ“‡å•†å“ï¼Œå†è¼¸å…¥æ•¸é‡
            </p>
          </div>
        </div>

        <div class="space-y-1">
          <label class="block text-xs text-slate-500 mb-1">å•†å“é …ç›®ï¼ˆä¾†è‡ª Google Sheetï¼‰</label>
          <select id="itemSelect"
            class="w-full border rounded-lg px-3 py-2 text-sm">
            <option value="">è¼‰å…¥ä¸­â€¦</option>
          </select>
          <p id="itemNote" class="text-[11px] text-slate-400 mt-1"></p>
        </div>

        <div class="grid grid-cols-2 gap-3 text-sm mt-2">
          <div>
            <label class="block text-xs text-slate-500 mb-1">æ•¸é‡</label>
            <input id="qtyInput" type="number" min="0" step="0.1"
              class="w-full border rounded-lg px-3 py-2 text-sm"
              placeholder="ä¾‹å¦‚ï¼š3ã€4.5" />
          </div>

          <div class="flex flex-col justify-between">
            <div>
              <span class="block text-xs text-slate-500 mb-1">å–®åƒ¹ Ã— æ•¸é‡</span>
              <p id="linePreview" class="text-sm font-medium text-slate-800">â€”</p>
            </div>
          </div>
        </div>

        <button id="addItemBtn"
          class="w-full mt-2 bg-emerald-700 text-white text-sm font-semibold py-2 rounded-xl shadow-md active:scale-95 transition disabled:bg-slate-300 disabled:text-slate-600">
          åŠ å…¥æœ¬æ¬¡å ±åƒ¹
        </button>
      </section>

      <!-- å ±åƒ¹æ¸…å–® -->
      <section class="bg-white rounded-2xl elevated p-4 space-y-3 mb-2">
        <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
          <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[11px] text-white">3</span>
          å ±åƒ¹é …ç›®æ¸…å–®
        </h2>

        <div id="quoteList" class="space-y-2 text-sm">
          <p class="text-xs text-slate-400">å°šæœªåŠ å…¥ä»»ä½•é …ç›®ã€‚</p>
        </div>

        <div class="border-t pt-2 mt-2 text-sm">
          <div class="flex justify-between items-center">
            <span class="text-slate-600 font-medium">å°è¨ˆ</span>
            <span id="subtotalDisplay" class="font-semibold text-slate-800">â€”</span>
          </div>

          <div class="flex items-center justify-between mt-2 text-xs">
            <label class="flex items-center gap-1 text-slate-600">
              <input id="ufCheckbox" type="checkbox" class="h-3 w-3" />
              <span>åŠ ä¸Šã€Œæœªæ»¿äº”è¬é‹è²»å·¥è³‡è£œè²¼ (UF)ã€</span>
            </label>
            <span id="ufAmountDisplay" class="text-slate-700">+ $0</span>
          </div>

          <div class="flex justify-between items-center mt-2 border-t pt-2">
            <span class="text-slate-700 font-semibold">ç¸½åƒ¹ï¼ˆå«é‹è²»é …ç›®ï¼‰</span>
            <span id="totalDisplay" class="text-lg font-bold text-emerald-700">â€”</span>
          </div>
        </div>
      </section>

    </main>

    <!-- åº•éƒ¨é€å‡º -->
    <footer class="fixed bottom-0 left-0 right-0 bg-[#022c22] border-t border-emerald-900/40">
      <div class="max-w-md mx-auto flex items-center justify-between px-4 py-3 gap-3">
        <div class="text-xs text-emerald-100">
          <p class="font-semibold text-emerald-50">å ±åƒ¹ç¸½é¡</p>
          <p id="footerTotal" class="text-lg font-bold text-emerald-300">â€”</p>
        </div>

        <button id="sendBtn"
          class="flex-1 bg-emerald-500 text-emerald-950 text-sm font-semibold py-2 rounded-xl shadow-lg active:scale-95 transition disabled:bg-slate-400">
          å‚³é€å ±åƒ¹çµ¦ LINE ç”¨æˆ¶
        </button>
      </div>
    </footer>
  </div>

  <script>
    /* -------------------------------
       1. ä½ çš„ Google Sheet å››å€‹å·¥ä½œè¡¨
    --------------------------------*/
    const SHEETS = [
      {
        url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=0&single=true&output=csv",
        defaultGroup: "æ«ƒé«”"
      },
      {
        url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=1520827127&single=true&output=csv",
        defaultGroup: "æŠ½å±œ"
      },
      {
        url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=71905260&single=true&output=csv",
        defaultGroup: "æ¿æ/å°æ¿"
      },
      {
        url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqtS5fA_DZBhjus9oMHTvFx7m_D7cp2ktfUQFGM9kAzJGZ7urNJWTXNpxRx2DCQdS36-Ov8Wiw3SoN/pub?gid=206474142&single=true&output=csv",
        defaultGroup: "äº”é‡‘/åŠ å·¥"
      }
    ];

    /* -------------------------------
       2. DOM åƒç…§
    --------------------------------*/
    const loadStatus = document.getElementById("loadStatus");
    const groupSelect = document.getElementById("groupSelect");
    const itemSelect = document.getElementById("itemSelect");
    const unitHint = document.getElementById("unitHint");
    const itemNote = document.getElementById("itemNote");
    const qtyInput = document.getElementById("qtyInput");
    const linePreview = document.getElementById("linePreview");
    const addItemBtn = document.getElementById("addItemBtn");
    const quoteList = document.getElementById("quoteList");
    const subtotalDisplay = document.getElementById("subtotalDisplay");
    const ufCheckbox = document.getElementById("ufCheckbox");
    const ufAmountDisplay = document.getElementById("ufAmountDisplay");
    const totalDisplay = document.getElementById("totalDisplay");
    const footerTotal = document.getElementById("footerTotal");
    const sendBtn = document.getElementById("sendBtn");

    const customerNameInput = document.getElementById("customerName");
    const customerPhoneInput = document.getElementById("customerPhone");

    let allItems = [];
    let quoteItems = [];
    let ufItem = null;

    /* -------------------------------
       3. CSV è§£æï¼ˆæ”¯æ´å«é€—è™Ÿèˆ‡å¼•è™Ÿï¼‰
    --------------------------------*/
    function parseCSV(text) {
      const rows = [];
      let current = "";
      let row = [];
      let insideQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const next = text[i + 1];

        if (char === '"' && insideQuotes && next === '"') {
          current += '"';
          i++;
        } else if (char === '"') {
          insideQuotes = !insideQuotes;
        } else if (char === "," && !insideQuotes) {
          row.push(current);
          current = "";
        } else if ((char === "\n" || char === "\r") && !insideQuotes) {
          if (current || row.length > 0) {
            row.push(current);
            rows.push(row);
            row = [];
            current = "";
          }
        } else {
          current += char;
        }
      }

      if (current || row.length) row.push(current);
      if (row.length) rows.push(row);

      return rows;
    }

    /* -------------------------------
       4. code â†’ ç¾¤çµ„ï¼ˆå‚™æ´ç”¨ï¼‰
    --------------------------------*/
    function inferGroup(code) {
      if (/^[1-9]/.test(code)) return "æ«ƒé«”";
      if (/^D/.test(code)) return "æŠ½å±œ";
      if (/^(FA|T)/.test(code)) return "æ¿æ/å°æ¿";
      if (/^(TJ|UF|Z)/.test(code)) return "äº”é‡‘/åŠ å·¥";
      return "å…¶ä»–";
    }

    /* -------------------------------
       5. å¾å››å€‹ Sheet è¼‰å…¥è³‡æ–™
    --------------------------------*/
    async function loadPriceList() {
      try {
        const allPromises = SHEETS.map(async (cfg) => {
          const res = await fetch(cfg.url);
          const text = await res.text();
          const rows = parseCSV(text);

          if (!rows.length) return [];

          const header = rows[0];
          const idxCode = header.indexOf("ç·¨ç¢¼");
          const idxName = header.indexOf("åç¨±");
          const idxUnit = header.indexOf("å–®ä½");
          const idxPrice = header.indexOf("å–®åƒ¹");
          const idxType = header.indexOf("é¡å‹");

          const items = rows.slice(1).map(r => {
            const code = r[idxCode] || "";
            const name = r[idxName] || "";
            const unit = r[idxUnit] || "";
            const price = parseFloat(r[idxPrice] || "0");
            const typeFromSheet = idxType >= 0 ? (r[idxType] || "") : "";
            const group = typeFromSheet || cfg.defaultGroup || inferGroup(code);

            return { code, name, unit, price, group };
          }).filter(x => x.code && !isNaN(x.price));

          return items;
        });

        const results = await Promise.all(allPromises);
        allItems = results.flat();

        // æ‰¾ UF
        ufItem = allItems.find(x => x.code === "UF") || null;

        loadStatus.textContent = `å·²å¾ 4 å€‹å·¥ä½œè¡¨è¼‰å…¥ ${allItems.length} ç­†è³‡æ–™ã€‚`;
        buildItemOptions();
        updateLinePreview();

      } catch (err) {
        console.error(err);
        loadStatus.textContent = "ğŸ“Œ ç„¡æ³•è®€å– Google Sheetï¼Œè«‹æª¢æŸ¥æ˜¯å¦å…¬é–‹ã€‚";
        itemSelect.innerHTML = `<option value="">è¼‰å…¥å¤±æ•—</option>`;
      }
    }

    /* -------------------------------
       6. ä¾ç¾¤çµ„åˆ·æ–°å•†å“ä¸‹æ‹‰
    --------------------------------*/
    function buildItemOptions() {
      const selectedGroup = groupSelect.value;

      const items = selectedGroup === "ALL"
        ? allItems
        : allItems.filter(x => x.group === selectedGroup);

      if (items.length === 0) {
        itemSelect.innerHTML = `<option value="">æ­¤ç¾¤çµ„ç„¡è³‡æ–™</option>`;
        addItemBtn.disabled = true;
        return;
      }

      itemSelect.innerHTML = items.map(x =>
        `<option value="${x.code}">[${x.code}] ${x.name}ï½œ${x.unit} $${x.price}</option>`
      ).join("");

      addItemBtn.disabled = false;
      updateUnitHint();
    }

    function getSelectedItem() {
      return allItems.find(x => x.code === itemSelect.value) || null;
    }

    function updateUnitHint() {
      const item = getSelectedItem();
      if (!item) {
        unitHint.textContent = "å…ˆé¸æ“‡å•†å“ï¼Œå†è¼¸å…¥æ•¸é‡";
        itemNote.textContent = "";
        return;
      }

      const map = {
        "æ«ƒé«”": "ä»¥ã€Œå°ºã€è¨ˆåƒ¹",
        "æŠ½å±œ": "ä»¥ã€Œçµ„ã€è¨ˆåƒ¹",
        "æ¿æ/å°æ¿": "ä»¥ã€Œæ‰ã€è¨ˆåƒ¹",
        "äº”é‡‘/åŠ å·¥": "ä¾å–®ä½ï¼ˆé¡†ï¼çµ„ï¼ç‰‡ï¼CMâ€¦ï¼‰è¨ˆåƒ¹"
      };

      unitHint.textContent = map[item.group] || "ä¾å–®ä½è¨ˆåƒ¹";
      itemNote.textContent = `å–®ä½ï¼š${item.unit}ï½œå–®åƒ¹ï¼š$${item.price}`;
    }

    function updateLinePreview() {
      const item = getSelectedItem();
      const qty = parseFloat(qtyInput.value || "0");

      if (!item || qty <= 0) {
        linePreview.textContent = "â€”";
        return;
      }

      const amount = Math.round(item.price * qty);
      linePreview.textContent = `$${item.price} Ã— ${qty} = $${amount.toLocaleString()}`;
    }

    /* -------------------------------
       7. å ±åƒ¹æ¸…å–® & é‡‘é¡è¨ˆç®—
    --------------------------------*/
    function renderQuoteList() {
      if (!quoteItems.length) {
        quoteList.innerHTML = '<p class="text-xs text-slate-400">å°šæœªåŠ å…¥ä»»ä½•é …ç›®ã€‚</p>';
        subtotalDisplay.textContent = "â€”";
        totalDisplay.textContent = "â€”";
        footerTotal.textContent = "â€”";
        ufAmountDisplay.textContent = "+ $0";
        sendBtn.disabled = true;
        return;
      }

      quoteList.innerHTML = quoteItems.map((it, i) => `
        <div class="flex items-start justify-between gap-2 border rounded-xl px-3 py-2">
          <div class="text-xs">
            <p class="font-semibold text-slate-800">[${it.code}] ${it.name}</p>
            <p class="text-[11px] text-slate-500 mt-[2px]">
              ç¾¤çµ„ï¼š${it.group} ï½œ æ•¸é‡ï¼š${it.qty} ${it.unit}ï½œå–®åƒ¹ $${it.price}ï½œå°è¨ˆ $${it.amount.toLocaleString()}
            </p>
          </div>
          <div class="flex flex-col items-end gap-1">
            <p class="text-sm font-semibold text-slate-900">$${it.amount.toLocaleString()}</p>
            <button data-idx="${i}" class="text-[11px] text-red-500 hover:underline remove-item">åˆªé™¤</button>
          </div>
        </div>
      `).join("");

      document.querySelectorAll(".remove-item").forEach(btn => {
        btn.addEventListener("click", e => {
          const index = parseInt(e.target.dataset.idx, 10);
          quoteItems.splice(index, 1);
          renderQuoteList();
          recalcTotal();
        });
      });

      sendBtn.disabled = false;
      recalcTotal();
    }

    function recalcTotal() {
      const subtotal = quoteItems.reduce((sum, it) => sum + it.amount, 0);
      subtotalDisplay.textContent = `$${subtotal.toLocaleString()}`;

      let ufAmount = 0;
      if (ufCheckbox.checked && ufItem) {
        ufAmount = ufItem.price;
        ufAmountDisplay.textContent = `+ $${ufAmount.toLocaleString()}ï¼ˆUFï¼‰`;
      } else {
        ufAmountDisplay.textContent = "+ $0";
      }

      const total = subtotal + ufAmount;
      totalDisplay.textContent = `$${total.toLocaleString()}`;
      footerTotal.textContent = `$${total.toLocaleString()}`;
    }

    /* -------------------------------
       8. çµ„æˆ LINE å ±åƒ¹æ–‡å­—
    --------------------------------*/
    function buildQuoteText() {
      const name = customerNameInput.value.trim();
      const phone = customerPhoneInput.value.trim();

      const subtotal = quoteItems.reduce((sum, it) => sum + it.amount, 0);
      const ufAdd = (ufCheckbox.checked && ufItem) ? ufItem.price : 0;
      const total = subtotal + ufAdd;

      const head = ["ã€è¦æ‹¼çµ„ ç³»çµ±æ«ƒå ±åƒ¹å–®ã€‘"];
      if (name) head.push(`å®¢æˆ¶ï¼š${name}`);
      if (phone) head.push(`é›»è©±ï¼š${phone}`);
      if (head.length > 1) head.push("");

      const items = quoteItems.map((it, i) =>
        `${i + 1}. [${it.code}] ${it.name}\n   æ•¸é‡ï¼š${it.qty} ${it.unit}ï½œå–®åƒ¹ $${it.price}ï½œå°è¨ˆ $${it.amount.toLocaleString()}`
      );

      const ufLines = [];
      if (ufAdd > 0 && ufItem) {
        ufLines.push("");
        ufLines.push(`é‹è²»ï¼è£œè²¼ï¼š${ufItem.name}ï¼ˆ${ufItem.code}ï¼‰ $${ufAdd.toLocaleString()}`);
      }

      const totalLines = [
        "",
        `å°è¨ˆï¼š$${subtotal.toLocaleString()}`,
        `ç¸½åƒ¹ï¼ˆå«é‹è²»é …ç›®ï¼‰ï¼š$${total.toLocaleString()}`,
        "",
        "â€» å¯¦éš›é‡‘é¡ä»¥ç¾å ´ä¸ˆé‡ã€è¨­è¨ˆåœ–èˆ‡åˆç´„ç‚ºæº–ã€‚"
      ];

      return [...head, ...items, ...ufLines, ...totalLines].join("\n");
    }

    /* -------------------------------
       9. LIFF ä¸²æ¥
    --------------------------------*/
    async function initLiff() {
      try {
        await liff.init({ liffId: "2008590887-zkqDbWqb" });
      } catch (err) {
        console.warn("LIFF åˆå§‹åŒ–å¤±æ•—ï¼ˆåœ¨ç€è¦½å™¨é è¦½å¯å¿½ç•¥ï¼‰ï¼š", err);
      }
    }

    async function sendToLine() {
      const text = buildQuoteText();
      try {
        if (typeof liff !== "undefined" && liff.isInClient && liff.isInClient()) {
          await liff.sendMessages([{ type: "text", text }]);
          alert("å·²å°‡å ±åƒ¹å–®å‚³çµ¦ LINE ç”¨æˆ¶");
          liff.closeWindow();
        } else {
          alert("ç›®å‰ä¸åœ¨ LINE App ä¸­ï¼Œé è¦½å ±åƒ¹å…§å®¹ï¼š\n\n" + text);
        }
      } catch (err) {
        console.error(err);
        alert("å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      }
    }

    /* -------------------------------
       10. åˆå§‹åŒ– & äº‹ä»¶
    --------------------------------*/
    function init() {
      loadPriceList();
      initLiff();

      groupSelect.addEventListener("change", () => {
        buildItemOptions();
      });

      itemSelect.addEventListener("change", () => {
        updateUnitHint();
        updateLinePreview();
      });

      qtyInput.addEventListener("input", () => {
        updateLinePreview();
      });

      addItemBtn.addEventListener("click", () => {
        const item = getSelectedItem();
        const qty = parseFloat(qtyInput.value || "0");

        if (!item || !qty || qty <= 0) {
          alert("è«‹å…ˆé¸æ“‡å•†å“ä¸¦è¼¸å…¥æœ‰æ•ˆæ•¸é‡");
          return;
        }

        const amount = Math.round(item.price * qty);
        quoteItems.push({
          code: item.code,
          name: item.name,
          unit: item.unit,
          price: item.price,
          group: item.group,
          qty,
          amount
        });

        qtyInput.value = "";
        updateLinePreview();
        renderQuoteList();
      });

      ufCheckbox.addEventListener("change", recalcTotal);
      sendBtn.addEventListener("click", sendToLine);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
